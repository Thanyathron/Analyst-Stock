<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - Enhanced Import/Export v2 (NEON API) - Full Version</title>
  <style>
    *{box-sizing:border-box}
    body{font-family:'Sarabun','Tahoma',sans-serif;background:#f4f6f8;margin:0;padding:20px}
    .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.08);overflow:hidden}
    .header{background:linear-gradient(45deg,#4CAF50,#2E7D32);color:#fff;padding:18px 20px}
    .header h1{margin:0;font-size:22px}
    .mode-selector{display:flex;gap:10px;flex-wrap:wrap;padding:14px 16px;border-bottom:1px solid #eee;background:#fafafa}
    .mode-btn{appearance:none;border:1px solid #e0e0e0;background:#fff;border-radius:999px;padding:10px 16px;font-size:14px;color:#333;cursor:pointer;transition:all .2s}
    .mode-btn.active{background:#4CAF50;border-color:#4CAF50;color:#fff}
    .mode-content{display:none;padding:16px}
    .mode-content.active{display:block}
    .subtabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
    .subtab-btn{appearance:none;border:1px solid #e0e0e0;background:#fff;border-radius:999px;padding:8px 12px;font-size:13px;color:#333;cursor:pointer}
    .subtab-btn.active{background:#2196F3;border-color:#2196F3;color:#fff}
    .subtab-content{display:none}
    .subtab-content.active{display:block}
    .form-row{display:flex;gap:12px;flex-wrap:wrap}
    .form-group{flex:1;min-width:220px}
    label{display:block;margin-bottom:6px;font-weight:600;color:#333}
    input[type="text"],input[type="number"],textarea,select{width:100%;padding:10px;border:1.5px solid #ddd;border-radius:8px;font-size:14px}
    input[type="file"]{width:100%;}
    textarea{resize:vertical}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .btn{border:none;border-radius:8px;padding:10px 14px;font-size:14px;color:#fff;background:#4CAF50;cursor:pointer}
    .btn.secondary{background:#2196F3}
    .btn.danger{background:#F44336}
    .btn.warning{background:#FF9800}
    .btn.gray{background:#607D8B}
    .btn.light{background:#9E9E9E}
    .btn.silver{background:#9E9E9E}
    .btn:disabled{background:#ccc;cursor:not-allowed}
    .table-container{overflow-x:auto;margin-top:10px}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:14px;vertical-align:middle}
    th{background:#fafafa}
    .thumb{width:44px;height:44px;object-fit:cover;border-radius:6px;border:1px solid #eee;cursor:zoom-in}
    .status-badge{padding:2px 8px;border-radius:12px;font-size:12px;font-weight:700;display:inline-block}
    .status-ok{background:#d4edda;color:#1b5e20}
    .status-buy{background:#fff3cd;color:#7a5d00}
    .status-pending{background:#e3f2fd;color:#0d47a1}
    .status-done{background:#e8f5e9;color:#1b5e20}
    .status-approved{background:#d4edda;color:#1b5e20}
    .status-rejected{background:#ffebee;color:#b71c1c}
    .status-ordered{background:#fff3cd;color:#7a5d00}
    .hint{font-size:12px;color:#777;margin-top:4px}
    .muted{color:#777;font-size:12px}
    .divider{height:1px;background:#eee;margin:8px 0}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal img{max-width:90vw;max-height:90vh;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.5)}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
    <h1>üì¶ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° NEON API) - Full Version</h1>
    <div>SPR, PR ‡πÅ‡∏•‡∏∞ Stock ‡∏û‡∏£‡πâ‡∏≠‡∏° Admin ‡πÅ‡∏¢‡∏Å, Import/Export, ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>
    </div>

    <div class="mode-selector" id="modeSelector">
    <button class="mode-btn active" data-target="#spr-mode">üìã SPR Mode</button>
    <button class="mode-btn" data-target="#pr-mode">üõí PR Mode</button>
    <button class="mode-btn" data-target="#stock-mode">üì¶ Stock</button>
    </div>

    <!-- SPR -->
    <div id="spr-mode" class="mode-content active">
    <h3>SPR - ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á</h3>
    <div class="actions" style="margin-top:0">
    <button class="btn gray" id="btn-spr-admin-login">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin (SPR) ‚Äî ‡∏£‡∏´‡∏±‡∏™: spr123</button>
    <button class="btn light" id="btn-spr-admin-logout">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (SPR)</button>
    <button class="btn warning" id="btn-spr-change-pass" disabled>üîë ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà (SPR)</button>
    <span id="spr-admin-state" class="muted">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ SPR: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</span>
    </div>

    <div class="subtabs" id="sprSubtabs">
    <button class="subtab-btn active" data-target="#spr-cart">SPR Cart</button>
    <button class="subtab-btn" data-target="#spr-history">History</button>
    </div>

    <!-- SPR Cart -->
    <div id="spr-cart" class="subtab-content active">
    <div class="form-row">
    <div class="form-group">
    <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠)</label>
    <input type="text" id="spr-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" />
    <label style="margin-top:8px">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
    <select id="spr-product-select"></select>
    </div>
    <div class="form-group">
    <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
    <input type="number" id="spr-quantity" min="1" value="1" />
    </div>
    </div>
    <div class="form-group">
    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å</label>
    <input type="text" id="spr-requester" placeholder="‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ" />
    </div>
    <div class="actions">
    <button class="btn" id="spr-add">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á SPR Cart</button>
    <div class="divider"></div>
    <button class="btn secondary" id="spr-export-cart">üì§ Export SPR Cart (CSV)</button>
    <button class="btn silver" id="spr-import-cart">üì• Import SPR Cart (CSV)</button>
    </div>
    <div class="table-container">
    <table>
    <thead>
    <tr>
    <th>#</th><th>‡∏£‡∏π‡∏õ</th><th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
    </tr>
    </thead>
    <tbody id="spr-body"><tr><td colspan="9" style="text-align:center;color:#777">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr></tbody>
    </table>
    </div>
    <div class="muted">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" ‡πÅ‡∏•‡∏∞ "‡∏•‡∏ö" ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin SPR</div>
    </div>

    <!-- SPR History -->
    <div id="spr-history" class="subtab-content">
    <div class="actions">
    <button class="btn secondary" id="spr-export-history">üì§ Export SPR History (CSV)</button>
    <button class="btn silver" id="spr-import-history">üì• Import SPR History (CSV)</button>
    </div>
    <div class="table-container">
    <table>
    <thead>
    <tr>
    <th>#</th><th>‡∏£‡∏π‡∏õ</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å</th><th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
    </tr>
    </thead>
    <tbody id="spr-history-body"><tr><td colspan="8" style="text-align:center;color:#777">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ SPR</td></tr></tbody>
    </table>
    </div>
    <div class="muted">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏õ‡∏∏‡πà‡∏° "‡∏•‡∏ö" ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin SPR</div>
    </div>
    </div>

    <!-- PR -->
    <div id="pr-mode" class="mode-content">
    <h3>PR - ‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
    <div class="actions" style="margin-top:0">
    <button class="btn gray" id="btn-pr-admin-login">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin (PR) ‚Äî ‡∏£‡∏´‡∏±‡∏™: admin123</button>
    <button class="btn light" id="btn-pr-admin-logout">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (PR)</button>
    <button class="btn warning" id="btn-pr-change-pass" disabled>üîë ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà (PR)</button>
    <span id="pr-admin-state" class="muted">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ PR: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</span>
    </div>

    <div class="subtabs" id="prSubtabs">
    <button class="subtab-btn active" data-target="#pr-cart">PR Cart</button>
    <button class="subtab-btn" data-target="#pr-history">History</button>
    </div>

    <!-- PR Cart -->
    <div id="pr-cart" class="subtab-content active">
    <div class="form-row">
    <div class="form-group">
    <label>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å)</label>
    <input type="text" id="pr-code" placeholder="‡πÄ‡∏ä‡πà‡∏ô ITEM001 (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ)" />
    </div>
    <div class="form-group">
    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
    <input type="text" id="pr-name" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å" list="stock-items-list" />
    <datalist id="stock-items-list"></datalist>
    <div class="hint">‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>
    </div>
    <div class="form-group">
    <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
    <input type="number" id="pr-qty" min="1" value="1" />
    </div>
    <div class="form-group">
    <label>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
    <input type="file" id="pr-image" accept="image/*" />
    </div>
    </div>
    <div class="form-row">
    <div class="form-group">
    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</label>
    <input type="text" id="pr-requester" placeholder="‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡πá‡πÑ‡∏î‡πâ" />
    </div>
    <div class="form-group">
    <label>Code Job</label>
    <input type="text" id="pr-job" />
    </div>
    <div class="form-group">
    <label>Remark</label>
    <input type="text" id="pr-remark" />
    </div>
    </div>
    <div class="actions">
    <button class="btn" id="pr-add">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á PR Cart</button>
    <div class="divider"></div>
    <button class="btn secondary" id="pr-export-cart">üì§ Export PR Cart (CSV)</button>
    <button class="btn silver" id="pr-import-cart">üì• Import PR Cart (CSV)</button>
    </div>
    <div class="table-container">
    <table>
    <thead>
    <tr>
    <th>#</th><th>‡∏£‡∏π‡∏õ</th><th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th><th>Job</th><th>Remark</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
    </tr>
    </thead>
    <tbody id="pr-body"><tr><td colspan="11" style="text-align:center;color:#777">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr></tbody>
    </table>
    </div>
    <div class="muted">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" ‡πÅ‡∏•‡∏∞ "‡∏•‡∏ö" ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin PR</div>
    </div>

    <!-- PR History -->
    <div id="pr-history" class="subtab-content">
    <div class="actions">
    <button class="btn secondary" id="pr-export-history">üì§ Export PR History (CSV)</button>
    <button class="btn silver" id="pr-import-history">üì• Import PR History (CSV)</button>
    </div>
    <div class="table-container">
    <table>
    <thead>
    <tr>
    <th>#</th><th>‡∏£‡∏π‡∏õ</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å</th><th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
    </tr>
    </thead>
    <tbody id="pr-history-body"><tr><td colspan="9" style="text-align:center;color:#777">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ PR</td></tr></tbody>
    </table>
    </div>
    </div>
    </div>

    <!-- Stock -->
    <div id="stock-mode" class="mode-content">
    <h3>Stock - ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
    <div class="actions" style="margin-top:0">
    <button class="btn gray" id="btn-stock-admin-login">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin (Stock) ‚Äî admin1: stock111, admin2: stock222</button>
    <button class="btn light" id="btn-stock-admin-logout">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (Stock)</button>
    <button class="btn warning" id="btn-stock-change-pass" disabled>üîë ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà (Stock)</button>
    <span id="stock-admin-state" class="muted">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Stock: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</span>
    </div>
    <div class="subtabs" id="stockSubtabs">
    <button class="subtab-btn active" data-target="#stock-items">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
    <button class="subtab-btn" data-target="#stock-history">History</button>
    </div>

    <!-- Subtab: Items -->
    <div id="stock-items" class="subtab-content active">
    <div class="form-row">
    <div class="form-group">
    <label>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î ‚Äî ‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter)</label>
    <input type="text" id="st-code" />
    </div>
    <div class="form-group">
    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
    <input type="text" id="st-name" />
    </div>
    <div class="form-group">
    <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö +5 / -3 / ‡∏´‡∏£‡∏∑‡∏≠ 20)</label>
    <input type="text" id="st-qty" value="1" />
    </div>
    <div class="form-group">
    <label>‡∏£‡∏≤‡∏Ñ‡∏≤</label>
    <input type="number" id="st-price" min="0" step="0.01" />
    </div>
    <div class="form-group">
    <label>Minimum Stock (‡∏ä‡∏¥‡πâ‡∏ô)</label>
    <input type="number" id="st-min" min="0" step="1" placeholder="0" />
    </div>
    <div class="form-group">
    <label>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
    <input type="file" id="st-image" accept="image/*" />
    </div>
    </div>
    <div class="actions">
    <button class="btn" id="st-add" disabled>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á (‡∏ö‡∏ß‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)</button>
    <button class="btn warning" id="st-update" disabled>üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö + / - / ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤ + ‡∏õ‡∏£‡∏±‡∏ö Min)</button>
    <button class="btn secondary" id="st-export">üì§ Export ‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
    <button class="btn silver" id="st-import">üì• Import ‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
    <button class="btn danger" id="st-clear" disabled>üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏•‡∏±‡∏á</button>
    </div>
    <div class="table-container">
    <table>
    <thead>
    <tr>
    <th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏£‡∏π‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>Minimum</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤</th><th>‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
    </tr>
    </thead>
    <tbody id="st-body"><tr><td colspan="10" style="text-align:center;color:#777">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr></tbody>
    </table>
    </div>
    <div class="muted">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin (admin1 ‡∏´‡∏£‡∏∑‡∏≠ admin2) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ</div>
    </div>

    <!-- Subtab: History -->
    <div id="stock-history" class="subtab-content">
    <div class="actions">
    <button class="btn secondary" id="his-export">üì§ Export History</button>
    <button class="btn danger" id="his-clear" disabled>üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
    </div>
    <div class="table-container">
    <table>
    <thead>
    <tr>
    <th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏£‡∏π‡∏õ</th><th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏•‡∏ö</th>
    </tr>
    </thead>
    <tbody id="his-body"><tr><td colspan="8" style="text-align:center;color:#777">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</td></tr></tbody>
    </table>
    </div>
    <div class="muted">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin (admin1 ‡∏´‡∏£‡∏∑‡∏≠ admin2) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ</div>
    </div>
    </div>
  </div>

  <!-- Image modal -->
  <div id="imgModal" class="modal" onclick="this.style.display='none'">
    <img id="imgModalPic" src="" alt="preview" />
  </div>

  <script>
    // --- State ---
    let stock = [];
    let spr = [];
    let sprHistory = [];
    let pr = [];
    let prHistory = [];
    let stockHistory = [];

    if(!localStorage.getItem('prAdminPass')) localStorage.setItem('prAdminPass','admin123');
    if(!localStorage.getItem('sprAdminPass')) localStorage.setItem('sprAdminPass','spr123');
    if(!localStorage.getItem('stockAdmin1Pass')) localStorage.setItem('stockAdmin1Pass','stock111');
    if(!localStorage.getItem('stockAdmin2Pass')) localStorage.setItem('stockAdmin2Pass','stock222');

    let isPRAdmin = sessionStorage.getItem('isPRAdmin') === 'true';
    let isSPRAdmin = sessionStorage.getItem('isSPRAdmin') === 'true';
    let isStockAdmin = sessionStorage.getItem('isStockAdmin') === 'true';
    let stockAdminUser = sessionStorage.getItem('stockAdminUser') || null; // 'admin1' | 'admin2'

    // NEON API Config
    const NEON_API_BASE = '/.netlify/functions/neon-proxy'; // ‡πÉ‡∏ä‡πâ proxy function ‡∏ö‡∏ô Netlify

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢ fetch JSON ‡∏û‡∏£‡πâ‡∏≠‡∏° header Authorization (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ proxy ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà token)
    async function neonFetchJSON(path, options = {}) {
      const res = await fetch(NEON_API_BASE + path, options);
      if (!res.ok) {
        const errText = await res.text();
        throw new Error(`API error ${res.status}: ${errText}`);
      }
      return res.json();
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô base64
    function readFileAsDataURL(file) {
      return new Promise((resolve) => {
        if (!file) { resolve(''); return; }
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result || '');
        reader.readAsDataURL(file);
      });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (resize/compress) ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
    async function processImageFile(file, mode) {
      if (!file) return '';
      const common = { maxW: 1024, maxH: 1024, maxKB: 300 };
      return await readAndResizeImage(file, common);
    }

    async function readAndResizeImage(file, opts = {}) {
      if (!file) return '';
      const {
        maxW = 1024,
        maxH = 1024,
        maxKB = 300,
        outputType = 'image/jpeg',
        qualityStart = 0.8,
        qualityMin = 0.5
      } = opts;
      function approxKB(dataUrl) {
        const base64 = (dataUrl.split(',')[1] || '');
        return Math.ceil((base64.length * 3 / 4) / 1024);
      }
      return await new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            let w = img.naturalWidth || img.width;
            let h = img.naturalHeight || img.height;
            const ratio = Math.min(maxW / w, maxH / h, 1);
            const cw = Math.max(1, Math.round(w * ratio));
            const ch = Math.max(1, Math.round(h * ratio));
            const canvas = document.createElement('canvas');
            canvas.width = cw; canvas.height = ch;
            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(img, 0, 0, cw, ch);
            let q = qualityStart;
            let out = canvas.toDataURL(outputType, q);
            while (approxKB(out) > maxKB && q > qualityMin) {
              q = Math.max(qualityMin, q - 0.1);
              out = canvas.toDataURL(outputType, q);
            }
            if (approxKB(out) > maxKB) {
              alert(`‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏Å‡∏¥‡∏ô ${maxKB}KB ‡∏´‡∏•‡∏±‡∏á‡∏¢‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á`);
              resolve('');
            } else {
              resolve(out);
            }
          };
          img.onerror = () => resolve('');
          img.src = e.target.result;
        };
        reader.onerror = () => resolve('');
        reader.readAsDataURL(file);
      });
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô render ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞ event handlers ---

    // SPR
    function renderSPR() {
      const tbody = document.getElementById('spr-body');
      tbody.innerHTML = '';
      if (spr.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#777">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
        return;
      }
      spr.forEach((item, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td><img src="${item.imageData || ''}" alt="‡∏£‡∏π‡∏õ" class="thumb" onclick="showImageModal('${item.imageData}')"></td>
          <td>${item.code}</td>
          <td>${item.name}</td>
          <td>${item.quantity}</td>
          <td>${item.requester}</td>
          <td><span class="status-badge status-pending">${item.status}</span></td>
          <td>${item.timestamp}</td>
          <td>
            ${isSPRAdmin ? `
              <button class="btn warning" onclick="changeSPRStatus(${i}, 'done')">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
              <button class="btn danger" onclick="deleteSPRItem(${i})">‡∏•‡∏ö</button>
            ` : ''}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function changeSPRStatus(index, newStatus) {
      if (!isSPRAdmin) return alert('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Admin SPR ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
      spr[index].status = newStatus;
      spr[index].timestamp = new Date().toLocaleString('th-TH');
      await saveSPR(spr[index]);
      await loadSPR();
    }

    async function deleteSPRItem(index) {
      if (!isSPRAdmin) return alert('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Admin SPR ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
      // TODO: ‡πÄ‡∏û‡∏¥‡πà‡∏° API ‡∏•‡∏ö‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      spr.splice(index, 1);
      await loadSPR();
    }

    function renderSPRHistory() {
      const tbody = document.getElementById('spr-history-body');
      tbody.innerHTML = '';
      if (sprHistory.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#777">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ SPR</td></tr>';
        return;
      }
      sprHistory.forEach((item, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td><img src="${item.imageData || ''}" alt="‡∏£‡∏π‡∏õ" class="thumb" onclick="showImageModal('${item.imageData}')"></td>
          <td>${item.timestamp}</td>
          <td>${item.requester}</td>
          <td>${item.code}</td>
          <td>${item.name}</td>
          <td>${item.quantity}</td>
          <td><span class="status-badge status-done">${item.status}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // PR
    function renderPR() {
      const tbody = document.getElementById('pr-body');
      tbody.innerHTML = '';
      if (pr.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;color:#777">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
        return;
      }
      pr.forEach((item, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td><img src="${item.imageData || ''}" alt="‡∏£‡∏π‡∏õ" class="thumb" onclick="showImageModal('${item.imageData}')"></td>
          <td>${item.code}</td>
          <td>${item.name}</td>
          <td>${item.quantity}</td>
          <td>${item.requester}</td>
          <td>${item.job}</td>
          <td>${item.remark}</td>
          <td>${item.timestamp}</td>
          <td><span class="status-badge status-pending">${item.status}</span></td>
          <td>
            ${isPRAdmin ? `
              <button class="btn warning" onclick="changePRStatus(${i}, 'approved')">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
              <button class="btn danger" onclick="deletePRItem(${i})">‡∏•‡∏ö</button>
            ` : ''}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function changePRStatus(index, newStatus) {
      if (!isPRAdmin) return alert('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Admin PR ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
      pr[index].status = newStatus;
      pr[index].timestamp = new Date().toLocaleString('th-TH');
      await savePR(pr[index]);
      await loadPR();
    }

    async function deletePRItem(index) {
      if (!isPRAdmin) return alert('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Admin PR ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
      // TODO: ‡πÄ‡∏û‡∏¥‡πà‡∏° API ‡∏•‡∏ö‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      pr.splice(index, 1);
      await loadPR();
    }

    function renderPRHistory() {
      const tbody = document.getElementById('pr-history-body');
      tbody.innerHTML = '';
      if (prHistory.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#777">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ PR</td></tr>';
        return;
      }
      prHistory.forEach((item, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td><img src="${item.imageData || ''}" alt="‡∏£‡∏π‡∏õ" class="thumb" onclick="showImageModal('${item.imageData}')"></td>
          <td>${item.timestamp}</td>
          <td>${item.requester}</td>
          <td>${item.code}</td>
          <td>${item.name}</td>
          <td>${item.quantity}</td>
          <td><span class="status-badge status-approved">${item.status}</span></td>
          <td></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Stock
    function renderStock() {
      const tbody = document.getElementById('st-body');
      tbody.innerHTML = '';
      if (stock.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:#777">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>';
        return;
      }
      stock.forEach((item, i) => {
        const statusClass = item.quantity <= item.minQty ? 'status-buy' : 'status-ok';
        const value = (item.price * item.quantity).toFixed(2);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.code}</td>
          <td><img src="${item.imageData || ''}" alt="‡∏£‡∏π‡∏õ" class="thumb" onclick="showImageModal('${item.imageData}')"></td>
          <td>${item.name}</td>
          <td>${item.price.toFixed(2)}</td>
          <td>${item.quantity}</td>
          <td>${item.minQty}</td>
          <td><span class="status-badge ${statusClass}">${item.quantity <= item.minQty ? '‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠' : '‡∏õ‡∏Å‡∏ï‡∏¥'}</span></td>
          <td>${value}</td>
          <td>${item.timestamp || ''}</td>
          <td>
            ${isStockAdmin ? `
              <button class="btn warning" onclick="editStockItem(${i})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class="btn danger" onclick="deleteStockItem(${i})">‡∏•‡∏ö</button>
            ` : ''}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function editStockItem(index) {
      if (!isStockAdmin) return alert('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Admin Stock ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
      const item = stock[index];
      document.getElementById('st-code').value = item.code;
      document.getElementById('st-name').value = item.name;
      document.getElementById('st-qty').value = item.quantity;
      document.getElementById('st-price').value = item.price;
      document.getElementById('st-min').value = item.minQty;
    }

    async function deleteStockItem(index) {
      if (!isStockAdmin) return alert('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Admin Stock ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
      // TODO: ‡πÄ‡∏û‡∏¥‡πà‡∏° API ‡∏•‡∏ö‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      stock.splice(index, 1);
      await loadStock();
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏¢‡∏≤‡∏¢ ---
    function showImageModal(src) {
      if (!src) return;
      const modal = document.getElementById('imgModal');
      const img = document.getElementById('imgModalPic');
      img.src = src;
      modal.style.display = 'flex';
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô export/import CSV ---
    function exportToCSV(data, filename) {
      const csvRows = [];
      if (data.length === 0) return;
      const headers = Object.keys(data[0]);
      csvRows.push(headers.join(','));
      for (const row of data) {
        const values = headers.map(h => {
          let val = row[h] === null || row[h] === undefined ? '' : row[h];
          val = val.toString().replace(/"/g, '""');
          if (val.search(/([",\n])/g) >= 0) {
            val = `"${val}"`;
          }
          return val;
        });
        csvRows.push(values.join(','));
      }
      const csvString = csvRows.join('\n');
      const blob = new Blob([csvString], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.setAttribute('hidden', '');
      a.setAttribute('href', url);
      a.setAttribute('download', filename);
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function importFromCSV(file, callback) {
      const reader = new FileReader();
      reader.onload = e => {
        const text = e.target.result;
        const lines = text.trim().split('\n');
        const headers = lines[0].split(',');
        const data = lines.slice(1).map(line => {
          const values = line.split(',');
          const obj = {};
          headers.forEach((h, i) => {
            obj[h] = values[i];
          });
          return obj;
        });
        callback(data);
      };
      reader.readAsText(file);
    }

    // --- Event handlers ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö export/import ---
    document.getElementById('spr-export-cart').addEventListener('click', () => {
      exportToCSV(spr, 'spr_cart.csv');
    });
    document.getElementById('spr-import-cart').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      importFromCSV(file, (data) => {
        spr = data;
        renderSPR();
      });
      e.target.value = '';
    });

    document.getElementById('spr-export-history').addEventListener('click', () => {
      exportToCSV(sprHistory, 'spr_history.csv');
    });
    document.getElementById('spr-import-history').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      importFromCSV(file, (data) => {
        sprHistory = data;
        renderSPRHistory();
      });
      e.target.value = '';
    });

    document.getElementById('pr-export-cart').addEventListener('click', () => {
      exportToCSV(pr, 'pr_cart.csv');
    });
    document.getElementById('pr-import-cart').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      importFromCSV(file, (data) => {
        pr = data;
        renderPR();
      });
      e.target.value = '';
    });

    document.getElementById('pr-export-history').addEventListener('click', () => {
      exportToCSV(prHistory, 'pr_history.csv');
    });
    document.getElementById('pr-import-history').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      importFromCSV(file, (data) => {
        prHistory = data;
        renderPRHistory();
      });
      e.target.value = '';
    });

    document.getElementById('st-export').addEventListener('click', () => {
      exportToCSV(stock, 'stock.csv');
    });
    document.getElementById('st-import').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      importFromCSV(file, (data) => {
        stock = data;
        renderStock();
      });
      e.target.value = '';
    });

    document.getElementById('his-export').addEventListener('click', () => {
      exportToCSV(stockHistory, 'stock_history.csv');
    });

    // --- Event handlers ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ---

    // SPR
    document.getElementById('spr-add').addEventListener('click', async () => {
      const code = document.getElementById('spr-product-select').value;
      const qty = parseInt(document.getElementById('spr-quantity').value) || 1;
      const req = (document.getElementById('spr-requester').value || '').trim() || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      if (!code) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
      const itemStock = stock.find(x => x.code === code);
      if (!itemStock) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á');
      if (itemStock.quantity < qty) return alert('‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏≠');
      const item = { code, name: itemStock.name, quantity: qty, requester: req, status: 'pending', timestamp: new Date().toLocaleString('th-TH'), imageData: itemStock.imageData || '' };
      spr.push(item);
      renderSPR();
      document.getElementById('spr-quantity').value = 1;
      document.getElementById('spr-requester').value = '';
    });

    // PR
    document.getElementById('pr-add').addEventListener('click', async () => {
      const code = (document.getElementById('pr-code').value || '').trim();
      let name = (document.getElementById('pr-name').value || '').trim();
      const qty = parseInt(document.getElementById('pr-qty').value) || 1;
      const requester = (document.getElementById('pr-requester').value || '').trim() || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      const job = (document.getElementById('pr-job').value || '').trim() || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      const remark = (document.getElementById('pr-remark').value || '').trim() || '-';
      const file = document.getElementById('pr-image').files[0] || null;
      if (!name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
      const finalCode = code || name;
      const imageData = await processImageFile(file, 'PR');
      const item = { code: finalCode, name, quantity: qty, requester, job, remark, status: 'pending', timestamp: new Date().toLocaleString('th-TH'), imageData };
      pr.push(item);
      renderPR();
      document.getElementById('pr-code').value = '';
      document.getElementById('pr-name').value = '';
      document.getElementById('pr-qty').value = 1;
      document.getElementById('pr-image').value = '';
    });

    // Stock
    document.getElementById('st-add').addEventListener('click', async () => {
      if (!isStockAdmin) return alert('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
      const code = (document.getElementById('st-code').value || '').trim();
      const name = (document.getElementById('st-name').value || '').trim();
      const qtyRaw = (document.getElementById('st-qty').value || '1').trim();
      const price = parseFloat(document.getElementById('st-price').value) || 0;
      const minQty = Math.max(0, parseInt(document.getElementById('st-min').value || '0'));
      const file = document.getElementById('st-image').files[0] || null;
      if (!code) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
      if (!name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
      // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö +5, -3, ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏£‡∏á‡πÜ
      let qty = 0;
      if (qtyRaw.startsWith('+') || qtyRaw.startsWith('-')) {
        const delta = parseInt(qtyRaw);
        const existing = stock.find(s => s.code === code);
        qty = (existing ? existing.quantity : 0) + delta;
      } else {
        qty = parseInt(qtyRaw) || 0;
      }
      if (qty < 0) qty = 0;
      const imageData = await processImageFile(file, 'Stock');
      const existingIndex = stock.findIndex(s => s.code === code);
      if (existingIndex >= 0) {
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
        stock[existingIndex].name = name;
        stock[existingIndex].quantity = qty;
        stock[existingIndex].price = price;
        stock[existingIndex].minQty = minQty;
        if (imageData) stock[existingIndex].imageData = imageData;
      } else {
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
        stock.push({ code, name, quantity: qty, price, minQty, imageData, timestamp: new Date().toLocaleString('th-TH') });
      }
      renderStock();
      // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°
      document.getElementById('st-code').value = '';
      document.getElementById('st-name').value = '';
      document.getElementById('st-qty').value = '1';
      document.getElementById('st-price').value = '';
      document.getElementById('st-min').value = '';
      document.getElementById('st-image').value = '';
    });

    document.getElementById('st-update').addEventListener('click', async () => {
      if (!isStockAdmin) return alert('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
      alert('‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤');
    });

    document.getElementById('st-clear').addEventListener('click', async () => {
      if (!isStockAdmin) return alert('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
      if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤?')) {
        stock = [];
        renderStock();
      }
    });

    document.getElementById('his-clear').addEventListener('click', async () => {
      if (!isStockAdmin) return alert('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
      if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥?')) {
        stockHistory = [];
        renderHistory();
      }
    });

    // --- Admin Login/Logout ---
    document.getElementById('btn-spr-admin-login').addEventListener('click', () => {
      const pass = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin SPR');
      if (pass === localStorage.getItem('sprAdminPass')) {
        isSPRAdmin = true;
        sessionStorage.setItem('isSPRAdmin', 'true');
        alert('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin SPR ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        updateAdminUI();
      } else {
        alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      }
    });

    document.getElementById('btn-spr-admin-logout').addEventListener('click', () => {
      isSPRAdmin = false;
      sessionStorage.setItem('isSPRAdmin', 'false');
      alert('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Admin SPR ‡πÅ‡∏•‡πâ‡∏ß');
      updateAdminUI();
    });

    document.getElementById('btn-pr-admin-login').addEventListener('click', () => {
      const pass = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin PR');
      if (pass === localStorage.getItem('prAdminPass')) {
        isPRAdmin = true;
        sessionStorage.setItem('isPRAdmin', 'true');
        alert('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin PR ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        updateAdminUI();
      } else {
        alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      }
    });

    document.getElementById('btn-pr-admin-logout').addEventListener('click', () => {
      isPRAdmin = false;
      sessionStorage.setItem('isPRAdmin', 'false');
      alert('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Admin PR ‡πÅ‡∏•‡πâ‡∏ß');
      updateAdminUI();
    });

    document.getElementById('btn-stock-admin-login').addEventListener('click', () => {
      const user = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ Admin Stock (admin1 ‡∏´‡∏£‡∏∑‡∏≠ admin2)');
      const pass = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin Stock');
      if ((user === 'admin1' && pass === localStorage.getItem('stockAdmin1Pass')) ||
          (user === 'admin2' && pass === localStorage.getItem('stockAdmin2Pass'))) {
        isStockAdmin = true;
        stockAdminUser = user;
        sessionStorage.setItem('isStockAdmin', 'true');
        sessionStorage.setItem('stockAdminUser', user);
        alert(`‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin Stock ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${user}`);
        updateAdminUI();
      } else {
        alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      }
    });

    document.getElementById('btn-stock-admin-logout').addEventListener('click', () => {
      isStockAdmin = false;
      stockAdminUser = null;
      sessionStorage.setItem('isStockAdmin', 'false');
      sessionStorage.removeItem('stockAdminUser');
      alert('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Admin Stock ‡πÅ‡∏•‡πâ‡∏ß');
      updateAdminUI();
    });

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ admin ---
    function updateAdminUI() {
      document.getElementById('spr-admin-state').textContent = isSPRAdmin ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ SPR: Admin' : '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ SPR: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
      document.getElementById('pr-admin-state').textContent = isPRAdmin ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ PR: Admin' : '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ PR: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
      document.getElementById('stock-admin-state').textContent = isStockAdmin ? `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Stock: Admin (${stockAdminUser})` : '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Stock: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';

      document.getElementById('btn-spr-change-pass').disabled = !isSPRAdmin;
      document.getElementById('btn-pr-change-pass').disabled = !isPRAdmin;
      document.getElementById('st-add').disabled = !isStockAdmin;
      document.getElementById('st-update').disabled = !isStockAdmin;
      document.getElementById('st-clear').disabled = !isStockAdmin;
      document.getElementById('his-clear').disabled = !isStockAdmin;
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞ render ---
    async function loadSPR() {
      // TODO: ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å API ‡πÅ‡∏ó‡∏ô localStorage
      renderSPR();
      renderSPRHistory();
    }

    async function loadPR() {
      renderPR();
      renderPRHistory();
    }

    async function loadStock() {
      renderStock();
    }

    // --- ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Mode Selector) ---
    document.querySelectorAll('.mode-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const target = btn.getAttribute('data-target');
        document.querySelectorAll('.mode-content').forEach(c => c.classList.remove('active'));
        document.querySelector(target).classList.add('active');
      });
    });

    // --- Subtabs ---
    document.querySelectorAll('.subtab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const parent = btn.closest('.mode-content');
        parent.querySelectorAll('.subtab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const target = btn.getAttribute('data-target');
        parent.querySelectorAll('.subtab-content').forEach(c => c.classList.remove('active'));
        parent.querySelector(target).classList.add('active');
      });
    });

    // --- ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ---
    window.onload = async () => {
      await loadStock();
      await loadSPR();
      await loadPR();
      updateAdminUI();
      // ‡πÄ‡∏ï‡∏¥‡∏° select ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô SPR
      fillSPRSelect();
      // ‡πÄ‡∏ï‡∏¥‡∏° datalist ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô PR
      fillStockDatalist();
    };

    // --- ‡πÄ‡∏ï‡∏¥‡∏° select ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô SPR ---
    function fillSPRSelect() {
      const select = document.getElementById('spr-product-select');
      select.innerHTML = '';
      stock.forEach(item => {
        const option = document.createElement('option');
        option.value = item.code;
        option.textContent = `${item.code} - ${item.name}`;
        select.appendChild(option);
      });
    }

    // --- ‡πÄ‡∏ï‡∏¥‡∏° datalist ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô PR ---
    function fillStockDatalist() {
      const datalist = document.getElementById('stock-items-list');
      datalist.innerHTML = '';
      stock.forEach(item => {
        const option = document.createElement('option');
        option.value = item.name;
        datalist.appendChild(option);
      });
    }
  </script>
</body>
</html>
