<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stock Scanner POS (HTML)</title>
  <style>
    :root {
      --primary: #1976d2;
      --primary-dark: #1565c0;
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --green: #2e7d32;
      --red: #c62828;
      --border: #e5e7eb;
      --chip1: #1976d2;
      --chip2: #1565c0;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--text); }
    .topbar { background: var(--primary); color: #fff; padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .topbar .left { display: flex; align-items: center; gap: 12px; }
    .title { font-weight: 600; font-size: 18px; }
    .chip { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 999px; font-size: 12px; font-weight: 600; }
    .chip.sku { background: var(--chip1); color: white; }
    .chip.units { background: var(--chip2); color: white; }
    .top-actions { display: flex; align-items: center; gap: 8px; }
    .btn { appearance: none; border: 1px solid transparent; padding: 8px 12px; border-radius: 8px; background: #fff; color: var(--text); cursor: pointer; font-weight: 600; font-size: 14px; }
    .btn:hover { filter: brightness(0.98); }
    .btn.primary { background: #fff1; color: #fff; border-color: #ffffff44; }
    .btn.primary:hover { background: #ffffff1f; }
    .btn.outline { background: transparent; border-color: #ffffff66; color: #fff; }
    .btn.danger { background: #ffffff0f; border-color: #ffffff33; color: #ffd1d1; }
    .btn.small { padding: 4px 8px; font-size: 12px; }
    .switch { display: inline-flex; align-items: center; gap: 6px; color: #fff; font-size: 13px; }
    .switch input { transform: scale(1.1); }

    .container { padding: 16px; max-width: 1200px; margin: 0 auto; }
    .banner { margin: 12px 16px; padding: 10px 12px; border: 1px solid #f59e0b; background: #fff7ed; color: #92400e; border-radius: 8px; }
    .hidden { display: none !important; }

    .tabs { display: flex; gap: 8px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 4px; }
    .tab { flex: 1; padding: 10px; text-align: center; border: 1px solid transparent; border-radius: 6px; background: transparent; cursor: pointer; font-weight: 600; color: var(--muted); }
    .tab.active { background: var(--primary); color: #fff; }

    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px) {
      .grid { grid-template-columns: 5fr 7fr; }
    }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
    .card h3 { margin: 0 0 8px 0; font-size: 18px; }
    .muted { color: var(--muted); font-size: 14px; }

    .row { display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }
    label { font-size: 13px; color: var(--muted); }
    input[type="text"], input[type="number"], input[type="search"], input[type="file"], input[type="datetime-local"] {
      width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; outline: none; font-size: 14px; background: #fff;
    }
    input[type="number"] { text-align: right; }

    .mode-switch { display: inline-flex; gap: 8px; background: #f1f5f9; padding: 4px; border-radius: 8px; border: 1px solid var(--border); }
    .mode-switch .seg { padding: 6px 10px; border-radius: 6px; cursor: pointer; font-weight: 600; color: var(--muted); }
    .mode-switch .seg.active { background: var(--primary); color: #fff; }

    .prefs { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
    .prefs .chk { display: inline-flex; align-items: center; gap: 6px; font-size: 14px; color: var(--text); }

    .table-wrap { max-height: 420px; overflow: auto; border: 1px solid var(--border); border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    thead th { position: sticky; top: 0; background: #f8fafc; border-bottom: 1px solid var(--border); text-align: left; padding: 8px; }
    tbody td { border-bottom: 1px solid var(--border); padding: 8px; vertical-align: middle; }
    tbody tr:hover { background: #fafafa; }

    .actions { display: flex; justify-content: flex-end; align-items: center; gap: 6px; }
    .badge { display: inline-block; padding: 6px 8px; border-radius: 8px; border: 1px solid var(--border); }
    .last-scan { border: 1px solid var(--border); border-radius: 8px; padding: 10px; }

    dialog::backdrop { background: rgb(0 0 0 / 0.4); }
    dialog { border: none; border-radius: 12px; padding: 0; }
    .dlg { padding: 16px; }
    .dlg header { padding: 16px; border-bottom: 1px solid var(--border); font-weight: 700; }
    .dlg .body { padding: 16px; }
    .dlg .footer { padding: 16px; display: flex; justify-content: flex-end; gap: 8px; border-top: 1px solid var(--border); }

    .toast { position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%) translateY(20px); padding: 10px 14px; background: #111827; color: #fff; border-radius: 999px; opacity: 0; transition: all 0.25s ease; pointer-events: none; font-size: 14px; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="left">
      <div class="title">Stock Scanner</div>
      <span class="chip sku">SKUs: <span id="skuCount">0</span></span>
      <span class="chip units">Units: <span id="unitCount">0</span></span>
    </div>
    <div class="top-actions">
      <label class="switch"><input type="checkbox" id="soundChk"> Scan sound</label>
      <button class="btn outline" id="exportBtn">Export</button>
      <button class="btn outline" id="importBtn">Import</button>
      <button class="btn outline" id="demoBtn">Demo</button>
      <button class="btn danger" id="clearBtn">Clear</button>
    </div>
  </div>

  <div id="storageBanner" class="banner hidden">Local storage is blocked in this browser. Data will not persist across refreshes.</div>

  <div class="container">
    <div class="tabs" style="margin-bottom: 12px;">
      <button class="tab active" id="tabBtn-scan">Scan</button>
      <button class="tab" id="tabBtn-inventory">Inventory</button>
      <button class="tab" id="tabBtn-movements">Movements</button>
    </div>

    <div id="tab-scan" class="tab-panel">
      <div class="grid">
        <div class="card">
          <h3>Scan with barcode scanner</h3>
          <div class="muted" style="margin-bottom: 12px;">Click inside the input, then scan. Most USB scanners type the code and send Enter.</div>
          <div class="row" style="margin-bottom: 12px; align-items: center;">
            <div class="mode-switch" id="modeSwitch">
              <div class="seg active" data-mode="add">Add Stock</div>
              <div class="seg" data-mode="remove">Remove Stock</div>
            </div>
            <div class="prefs">
              <label class="chk"><input type="checkbox" id="autoResetQtyChk" checked> Auto reset qty</label>
              <label class="chk"><input type="checkbox" id="allowNegativeChk"> Allow negative</label>
            </div>
          </div>
          <div class="row">
            <div style="flex: 1; min-width: 260px;">
              <label>Scan barcode (press Enter)</label>
              <input type="text" id="scanCodeInput" placeholder="Scan or type code and press Enter" />
            </div>
            <div style="width: 140px;">
              <label>Qty</label>
              <input type="number" id="scanQtyInput" min="1" value="1" />
            </div>
            <div>
              <button class="btn" id="applyScanBtn" style="background: var(--primary); color: #fff;">Apply</button>
            </div>
          </div>

          <div id="lastResultBox" class="last-scan" style="margin-top: 14px; display: none;"></div>
        </div>

        <div class="card">
          <div class="row" style="justify-content: space-between; margin-bottom: 8px; align-items: center;">
            <h3 style="margin:0">Inventory</h3>
            <div style="width: 260px;">
              <input type="search" id="searchInput" placeholder="Search by SKU or name" />
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="width: 200px;">SKU</th>
                  <th>Name</th>
                  <th style="width: 120px; text-align: right;">Stock</th>
                  <th style="width: 120px; text-align: right;">Price</th>
                  <th style="width: 200px; text-align: right;">Actions</th>
                </tr>
              </thead>
              <tbody id="inventoryTableBody"></tbody>
            </table>
          </div>
          <div style="margin-top: 10px;">
            <button class="btn" id="addRowBtn">Add Row</button>
          </div>
        </div>
      </div>
    </div>

    <div id="tab-inventory" class="tab-panel hidden">
      <div class="card">
        <div class="row" style="justify-content: space-between; margin-bottom: 8px; align-items: center;">
          <h3 style="margin:0">Inventory</h3>
          <div style="width: 260px;">
            <input type="search" id="searchInput2" placeholder="Search by SKU or name" />
          </div>
        </div>
        <div class="table-wrap" style="max-height: 560px;">
          <table>
            <thead>
              <tr>
                <th style="width: 200px;">SKU</th>
                <th>Name</th>
                <th style="width: 120px; text-align: right;">Stock</th>
                <th style="width: 120px; text-align: right;">Price</th>
                <th style="width: 200px; text-align: right;">Actions</th>
              </tr>
            </thead>
            <tbody id="inventoryTableBody2"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="tab-movements" class="tab-panel hidden">
      <div class="card">
        <h3>Movements (latest 1000)</h3>
        <div class="table-wrap" style="max-height: 560px;">
          <table>
            <thead>
              <tr>
                <th style="width: 220px;">Time</th>
                <th style="width: 200px;">SKU</th>
                <th>Name</th>
                <th style="width: 100px; text-align: right;">Qty</th>
                <th style="width: 120px; text-align: right;">Change</th>
              </tr>
            </thead>
            <tbody id="movementsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <dialog id="createDialog">
    <div class="dlg">
      <header>New item from scan</header>
      <div class="body">
        <div class="muted" style="margin-bottom: 8px;">Scanned code not found. Create an item to attach to this code.</div>
        <div style="margin-bottom: 8px;">
          <label>SKU / Barcode</label>
          <input type="text" id="pendingCodeInput" />
        </div>
        <div style="margin-bottom: 8px;">
          <label>Name</label>
          <input type="text" id="newItemNameInput" />
        </div>
        <div>
          <label>Price (optional)</label>
          <input type="text" id="newItemPriceInput" />
        </div>
      </div>
      <div class="footer">
        <button class="btn" id="createCancelBtn">Cancel</button>
        <button class="btn" id="createSaveApplyBtn" style="background: var(--primary); color: #fff;">Save & Apply Scan</button>
      </div>
    </div>
  </dialog>

  <input type="file" id="importFile" accept=".csv" class="hidden" />

  <div id="toast" class="toast"></div>

  <script>
    // ---------------- Utilities ----------------
    function makeStorage() {
      try {
        const k = '__probe__';
        localStorage.setItem(k, '1');
        localStorage.removeItem(k);
        return localStorage;
      } catch (e) {
        const mem = {};
        return {
          getItem: (k) => (k in mem ? mem[k] : null),
          setItem: (k, v) => { mem[k] = String(v); },
          removeItem: (k) => { delete mem[k]; },
        };
      }
    }
    const storage = makeStorage();
    const STORAGE_KEYS = { items: 'ssi_items', movements: 'ssi_movements', prefs: 'ssi_prefs' };

    function loadJSON(key, fallback) {
      try {
        const raw = storage.getItem(key);
        if (!raw) return fallback;
        return JSON.parse(raw);
      } catch { return fallback; }
    }
    function saveJSON(key, val) {
      try { storage.setItem(key, JSON.stringify(val)); return true; } catch { return false; }
    }
    function uid(prefix = 'id') { return prefix + '_' + Math.random().toString(36).slice(2, 10); }
    function nowIso() { return new Date().toISOString(); }
    function humanDate(iso) { try { return new Date(iso).toLocaleString(); } catch { return iso; } }
    function sumUnits(items) { return items.reduce((s, it) => s + (Number(it.stock) || 0), 0); }
    function showToast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => el.classList.remove('show'), 2500);
    }
    function toCSV(items) {
      const header = ['sku','name','stock','price'];
      const lines = [header.join(',')];
      for (const it of items) {
        const row = [it.sku, it.name, it.stock, it.price ?? ''];
        const escaped = row.map(v => {
          const s = String(v ?? '');
          return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
        });
        lines.push(escaped.join(','));
      }
      return lines.join('\n');
    }
    function download(filename, text, mime='text/plain') {
      const blob = new Blob([text], { type: mime + ';charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    // Web Audio beep
    let audioCtx = null;
    function ensureAudioCtx() {
      if (!audioCtx) {
        try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch {}
      }
      return audioCtx;
    }
    function beep(freq = 880, ms = 80) {
      if (!state.prefs.sound) return;
      const ctx = ensureAudioCtx();
      if (!ctx) return;
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.value = freq;
      gain.gain.value = 0.02;
      osc.connect(gain).connect(ctx.destination);
      const t = ctx.currentTime;
      osc.start(t);
      osc.stop(t + ms/1000);
    }

    // ---------------- State ----------------
    const state = {
      items: loadJSON(STORAGE_KEYS.items, [
        { id: uid('sku'), sku: '012345678905', name: 'Demo Widget A', stock: 12, price: 9.99 },
        { id: uid('sku'), sku: '012345678906', name: 'Demo Widget B', stock: 8, price: 14.5 },
        { id: uid('sku'), sku: 'ABC123', name: 'Demo Part C', stock: 20, price: 4.25 },
      ]),
      movements: loadJSON(STORAGE_KEYS.movements, []),
      prefs: loadJSON(STORAGE_KEYS.prefs, { allowNegative: false, autoResetQty: true, sound: false }),
      search: '',
      tab: 'scan', // 'scan' | 'inventory' | 'movements'
      mode: 'add', // 'add' | 'remove'
      scanCode: '',
      scanQty: 1,
      lastScan: null, // { sku, name, qty, delta, stockAfter }
      storageOk: true,
      pendingCode: '',
      pendingApply: false,
    };

    // Probe storage once
    (function(){ try { state.storageOk = saveJSON('__probe__', { t: Date.now() }); } catch { state.storageOk = false; } })();

    // ---------------- DOM Refs ----------------
    const skuCountEl = document.getElementById('skuCount');
    const unitCountEl = document.getElementById('unitCount');
    const storageBanner = document.getElementById('storageBanner');

    const tabBtnScan = document.getElementById('tabBtn-scan');
    const tabBtnInv = document.getElementById('tabBtn-inventory');
    const tabBtnMov = document.getElementById('tabBtn-movements');
    const tabScan = document.getElementById('tab-scan');
    const tabInv = document.getElementById('tab-inventory');
    const tabMov = document.getElementById('tab-movements');

    const soundChk = document.getElementById('soundChk');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const demoBtn = document.getElementById('demoBtn');
    const clearBtn = document.getElementById('clearBtn');

    const searchInput = document.getElementById('searchInput');
    const searchInput2 = document.getElementById('searchInput2');

    const modeSwitch = document.getElementById('modeSwitch');
    const autoResetQtyChk = document.getElementById('autoResetQtyChk');
    const allowNegativeChk = document.getElementById('allowNegativeChk');

    const scanCodeInput = document.getElementById('scanCodeInput');
    const scanQtyInput = document.getElementById('scanQtyInput');
    const applyScanBtn = document.getElementById('applyScanBtn');
    const lastResultBox = document.getElementById('lastResultBox');

    const invTbody1 = document.getElementById('inventoryTableBody');
    const invTbody2 = document.getElementById('inventoryTableBody2');
    const addRowBtn = document.getElementById('addRowBtn');

    const movTbody = document.getElementById('movementsTableBody');

    const createDialog = document.getElementById('createDialog');
    const pendingCodeInput = document.getElementById('pendingCodeInput');
    const newItemNameInput = document.getElementById('newItemNameInput');
    const newItemPriceInput = document.getElementById('newItemPriceInput');
    const createCancelBtn = document.getElementById('createCancelBtn');
    const createSaveApplyBtn = document.getElementById('createSaveApplyBtn');

    // ---------------- Helpers ----------------
    function saveAll() { saveJSON(STORAGE_KEYS.items, state.items); saveJSON(STORAGE_KEYS.movements, state.movements); saveJSON(STORAGE_KEYS.prefs, state.prefs); }
    function setItems(fnOrArr) { state.items = typeof fnOrArr === 'function' ? fnOrArr(state.items) : fnOrArr; saveJSON(STORAGE_KEYS.items, state.items); render(); }
    function setMovements(fnOrArr) { state.movements = typeof fnOrArr === 'function' ? fnOrArr(state.movements) : fnOrArr; saveJSON(STORAGE_KEYS.movements, state.movements); render(); }
    function setPrefs(patch) { state.prefs = { ...state.prefs, ...patch }; saveJSON(STORAGE_KEYS.prefs, state.prefs); render(); }

    function findItemBySku(code) {
      const c = String(code || '').trim().toLowerCase();
      if (!c) return null;
      return state.items.find(it => String(it.sku).trim().toLowerCase() === c) || null;
    }
    function upsertItem(obj) {
      const key = String(obj.sku).trim().toLowerCase();
      let found = false;
      const next = state.items.map(it => {
        if (String(it.sku).trim().toLowerCase() === key) { found = true; return { ...it, ...obj }; }
        return it;
      });
      if (!found) next.unshift({ id: uid('sku'), stock: 0, price: '', ...obj });
      setItems(next);
    }
    function recordMovement({ sku, name, qty, mode }) {
      const delta = mode === 'add' ? qty : -qty;
      setMovements(prev => [{ id: uid('mv'), ts: nowIso(), sku, name, qty, mode, delta }, ...prev].slice(0, 1000));
    }

    function processScan(code, qty) {
      const clean = String(code || '').trim();
      const nQty = Math.max(1, parseInt(qty, 10) || 1);
      if (!clean) { showToast('Scan a code first.'); return; }
      const found = findItemBySku(clean);
      if (!found) {
        state.pendingCode = clean;
        state.pendingApply = true;
        openCreateDialog();
        beep(440, 160);
        return;
      }
      const delta = state.mode === 'add' ? nQty : -nQty;
      const allowNeg = !!state.prefs.allowNegative;
      state.items = state.items.map(it => {
        if (it.id !== found.id) return it;
        const nextStock = (Number(it.stock) || 0) + delta;
        return { ...it, stock: allowNeg ? nextStock : Math.max(0, nextStock) };
      });
      saveJSON(STORAGE_KEYS.items, state.items);
      recordMovement({ sku: found.sku, name: found.name, qty: nQty, mode: state.mode });
      state.lastScan = { sku: found.sku, name: found.name, qty: nQty, delta, stockAfter: (Number(found.stock)||0) + delta };
      render();
      showToast((state.mode === 'add' ? 'Added ' : 'Removed ') + nQty + ' • ' + found.name + ' (' + found.sku + ')');
      beep(880, 80);
      if (state.prefs.autoResetQty) state.scanQty = 1;
      state.scanCode = '';
      renderScanInputs();
      focusScanInputSoon();
    }

    function focusScanInputSoon() { setTimeout(() => { scanCodeInput.focus(); scanCodeInput.select && scanCodeInput.select(); }, 0); }

    function openCreateDialog() {
      pendingCodeInput.value = state.pendingCode;
      newItemNameInput.value = '';
      newItemPriceInput.value = '';
      try { createDialog.showModal(); } catch { createDialog.setAttribute('open',''); }
      pendingCodeInput.focus();
    }
    function closeCreateDialog() { try { createDialog.close(); } catch { createDialog.removeAttribute('open'); } }

    function handleCreateSave(applyScan = true) {
      const sku = pendingCodeInput.value.trim();
      const name = newItemNameInput.value.trim() || ('Item ' + sku);
      const price = newItemPriceInput.value.trim();
      upsertItem({ sku, name, price, stock: 0 });
      closeCreateDialog();
      showToast('Created item ' + name + ' (' + sku + ')');
      if (applyScan && state.pendingApply) {
        const qty = state.scanQty;
        setTimeout(() => processScan(sku, qty), 0);
      }
    }

    function adjustItemStock(id, delta) {
      const allowNeg = !!state.prefs.allowNegative;
      state.items = state.items.map(it => {
        if (it.id !== id) return it;
        const nextStock = (Number(it.stock) || 0) + delta;
        return { ...it, stock: allowNeg ? nextStock : Math.max(0, nextStock) };
      });
      saveJSON(STORAGE_KEYS.items, state.items);
      render();
    }

    function setItemField(id, field, value) {
      state.items = state.items.map(it => it.id === id ? { ...it, [field]: field === 'stock' ? (parseInt(value, 10) || 0) : value } : it);
      saveJSON(STORAGE_KEYS.items, state.items);
      render();
    }

    function deleteItem(id) {
      if (!confirm('Delete this item?')) return;
      state.items = state.items.filter(it => it.id !== id);
      saveJSON(STORAGE_KEYS.items, state.items);
      render();
    }

    function filteredItems() {
      const q = String(state.search || '').trim().toLowerCase();
      if (!q) return state.items;
      return state.items.filter(it => String(it.sku).toLowerCase().includes(q) || String(it.name).toLowerCase().includes(q));
    }

    function importCSVFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const text = String(e.target.result || '');
          const lines = text.split(/\r?\n/).filter(Boolean);
          if (lines.length === 0) throw new Error('Empty file');
          let startIdx = 0;
          const header = lines[0].split(',').map(h => h.trim().toLowerCase());
          if (header.includes('sku') && header.includes('name')) startIdx = 1;
          const incoming = [];
          for (let i = startIdx; i < lines.length; i++) {
            const raw = lines[i];
            // naive split, suitable for simple CSVs
            const parts = raw.split(',');
            const sku = (parts[0] || '').trim();
            const name = (parts[1] || '').trim();
            const stock = Number(parts[2] || '0') || 0;
            const price = (parts[3] || '').trim();
            if (sku && name) incoming.push({ sku, name, stock, price });
          }
          if (incoming.length === 0) throw new Error('No valid rows');
          const map = new Map(state.items.map(it => [String(it.sku).toLowerCase(), it]));
          for (const inc of incoming) {
            const key = String(inc.sku).toLowerCase();
            if (map.has(key)) map.set(key, { ...map.get(key), ...inc }); else map.set(key, { id: uid('sku'), stock: 0, price: '', ...inc });
          }
          state.items = Array.from(map.values());
          saveJSON(STORAGE_KEYS.items, state.items);
          render();
          showToast('Imported ' + incoming.length + ' item(s)');
        } catch (err) {
          showToast('Import failed: ' + (err.message || err));
        }
      };
      reader.onerror = () => showToast('Failed to read file');
      reader.readAsText(file);
    }

    function loadDemo() {
      if (!confirm('Load demo items? This merges with your current items.')) return;
      const demos = [
        { sku: '012345678905', name: 'Demo Widget A', stock: 12, price: 9.99 },
        { sku: '012345678906', name: 'Demo Widget B', stock: 8, price: 14.5 },
        { sku: 'ABC123', name: 'Demo Part C', stock: 20, price: 4.25 },
      ];
      const map = new Map(state.items.map(it => [String(it.sku).toLowerCase(), it]));
      for (const it of demos) { const k = String(it.sku).toLowerCase(); if (!map.has(k)) map.set(k, { id: uid('sku'), ...it }); }
      state.items = Array.from(map.values());
      saveJSON(STORAGE_KEYS.items, state.items);
      render();
      showToast('Demo items loaded');
    }

    function clearAll() {
      if (!confirm('Clear all inventory and movements?')) return;
      state.items = [];
      state.movements = [];
      saveAll();
      render();
      showToast('Cleared all data');
    }

    // ---------------- Renderers ----------------
    function render() {
      // top counters
      skuCountEl.textContent = String(state.items.length);
      unitCountEl.textContent = String(sumUnits(state.items));
      storageBanner.classList.toggle('hidden', !!state.storageOk);

      // tab active
      tabBtnScan.classList.toggle('active', state.tab === 'scan');
      tabBtnInv.classList.toggle('active', state.tab === 'inventory');
      tabBtnMov.classList.toggle('active', state.tab === 'movements');
      tabScan.classList.toggle('hidden', state.tab !== 'scan');
      tabInv.classList.toggle('hidden', state.tab !== 'inventory');
      tabMov.classList.toggle('hidden', state.tab !== 'movements');

      // scan mode segments
      Array.from(modeSwitch.querySelectorAll('.seg')).forEach(seg => seg.classList.toggle('active', seg.dataset.mode === state.mode));

      // prefs
      autoResetQtyChk.checked = !!state.prefs.autoResetQty;
      allowNegativeChk.checked = !!state.prefs.allowNegative;
      soundChk.checked = !!state.prefs.sound;

      // search inputs
      if (document.activeElement !== searchInput) searchInput.value = state.search;
      if (document.activeElement !== searchInput2) searchInput2.value = state.search;

      // inventory tables
      renderInventory(invTbody1);
      renderInventory(invTbody2);

      // movements
      renderMovements();

      // last scan box
      renderLastScan();

      // scan inputs
      renderScanInputs();
    }

    function renderScanInputs() {
      if (document.activeElement !== scanCodeInput) scanCodeInput.value = state.scanCode;
      if (document.activeElement !== scanQtyInput) scanQtyInput.value = state.scanQty;
    }

    function renderLastScan() {
      if (!state.lastScan) { lastResultBox.style.display = 'none'; return; }
      const r = state.lastScan;
      const green = r.delta >= 0;
      lastResultBox.style.display = 'block';
      lastResultBox.style.background = green ? '#e8f5e9' : '#ffebee';
      lastResultBox.style.borderColor = green ? '#a5d6a7' : '#ef9a9a';
      lastResultBox.innerHTML = `
        <div class="muted">Last scan</div>
        <div style="font-size: 16px; font-weight: 600;">${green ? 'Added' : 'Removed'} ${Math.abs(r.delta)} • ${r.name} (${r.sku})</div>
        <div class="muted">Stock after: ${r.stockAfter}</div>
      `;
    }

    function renderInventory(tbody) {
      const list = filteredItems();
      if (!tbody) return;
      if (list.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: var(--muted); padding: 16px;">No items. Scan to add, import CSV, or click Demo.</td></tr>`;
        return;
      }
      tbody.innerHTML = list.map(it => `
        <tr data-id="${it.id}">
          <td><input type="text" class="inp sku" value="${escapeHtml(it.sku)}" /></td>
          <td><input type="text" class="inp name" value="${escapeHtml(it.name)}" /></td>
          <td style="text-align: right;">
            <div class="actions" style="justify-content: flex-end;">
              <button class="btn small minus">-</button>
              <input type="number" class="inp stock" value="${Number(it.stock) || 0}" style="width: 80px;" />
              <button class="btn small plus">+</button>
            </div>
          </td>
          <td style="text-align: right;"><input type="text" class="inp price" value="${escapeHtml(it.price ?? '')}" style="width: 100px; text-align: right;" /></td>
          <td style="text-align: right;">
            <div class="actions">
              <button class="btn small quickAdd">+1</button>
              <button class="btn small quickRemove">-1</button>
              <button class="btn small danger del">Delete</button>
            </div>
          </td>
        </tr>
      `).join('');

      // attach handlers
      tbody.querySelectorAll('tr').forEach(tr => {
        const id = tr.getAttribute('data-id');
        const skuInp = tr.querySelector('.inp.sku');
        const nameInp = tr.querySelector('.inp.name');
        const stockInp = tr.querySelector('.inp.stock');
        const priceInp = tr.querySelector('.inp.price');
        const btnMinus = tr.querySelector('.minus');
        const btnPlus = tr.querySelector('.plus');
        const btnQuickAdd = tr.querySelector('.quickAdd');
        const btnQuickRemove = tr.querySelector('.quickRemove');
        const btnDel = tr.querySelector('.del');

        skuInp.addEventListener('change', () => setItemField(id, 'sku', skuInp.value));
        nameInp.addEventListener('change', () => setItemField(id, 'name', nameInp.value));
        stockInp.addEventListener('change', () => setItemField(id, 'stock', parseInt(stockInp.value, 10) || 0));
        priceInp.addEventListener('change', () => setItemField(id, 'price', priceInp.value));
        btnMinus.addEventListener('click', () => adjustItemStock(id, -1));
        btnPlus.addEventListener('click', () => adjustItemStock(id, +1));
        btnQuickAdd.addEventListener('click', () => { state.mode = 'add'; processScan(findItemById(id).sku, 1); });
        btnQuickRemove.addEventListener('click', () => { state.mode = 'remove'; processScan(findItemById(id).sku, 1); });
        btnDel.addEventListener('click', () => deleteItem(id));
      });
    }

    function findItemById(id) { return state.items.find(it => it.id === id); }

    function escapeHtml(s) { return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    function renderMovements() {
      const rows = state.movements.map(mv => `
        <tr>
          <td>${escapeHtml(humanDate(mv.ts))}</td>
          <td>${escapeHtml(mv.sku)}</td>
          <td>${escapeHtml(mv.name)}</td>
          <td style="text-align: right;">${mv.qty}</td>
          <td style="text-align: right; color: ${mv.delta >= 0 ? 'var(--green)':'var(--red)'};">${mv.delta >= 0 ? '+' : ''}${mv.delta}</td>
        </tr>
      `).join('');
      movTbody.innerHTML = rows || `<tr><td colspan="5" style="text-align:center; color: var(--muted); padding: 16px;">No movements yet.</td></tr>`;
    }

    // ---------------- Events ----------------
    tabBtnScan.addEventListener('click', () => { state.tab = 'scan'; render(); focusScanInputSoon(); });
    tabBtnInv.addEventListener('click', () => { state.tab = 'inventory'; render(); });
    tabBtnMov.addEventListener('click', () => { state.tab = 'movements'; render(); });

    soundChk.addEventListener('change', () => { setPrefs({ sound: !!soundChk.checked }); if (soundChk.checked) ensureAudioCtx(); });
    exportBtn.addEventListener('click', () => download('inventory.csv', toCSV(state.items), 'text/csv'));
    importBtn.addEventListener('click', () => importFile.click());
    importFile.addEventListener('change', (e) => { const f = e.target.files && e.target.files[0]; if (f) importCSVFile(f); e.target.value = ''; });
    demoBtn.addEventListener('click', loadDemo);
    clearBtn.addEventListener('click', clearAll);

    searchInput.addEventListener('input', () => { state.search = searchInput.value; render(); });
    searchInput2.addEventListener('input', () => { state.search = searchInput2.value; render(); });

    modeSwitch.querySelectorAll('.seg').forEach(seg => seg.addEventListener('click', () => { state.mode = seg.dataset.mode; render(); focusScanInputSoon(); }));
    autoResetQtyChk.addEventListener('change', () => setPrefs({ autoResetQty: !!autoResetQtyChk.checked }));
    allowNegativeChk.addEventListener('change', () => setPrefs({ allowNegative: !!allowNegativeChk.checked }));

    scanCodeInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); processScan(state.scanCode, state.scanQty); } });
    scanCodeInput.addEventListener('input', () => { state.scanCode = scanCodeInput.value; });
    scanQtyInput.addEventListener('input', () => { let v = parseInt(scanQtyInput.value, 10)||1; if (v < 1) v = 1; state.scanQty = v; scanQtyInput.value = v; });
    applyScanBtn.addEventListener('click', () => processScan(state.scanCode, state.scanQty));

    addRowBtn.addEventListener('click', () => setItems(prev => [{ id: uid('sku'), sku: 'NEW-SKU', name: 'New Item', stock: 0, price: '' }, ...prev]));

    createCancelBtn.addEventListener('click', () => { state.pendingApply = false; closeCreateDialog(); showToast('Scan canceled'); focusScanInputSoon(); });
    createSaveApplyBtn.addEventListener('click', () => { handleCreateSave(true); focusScanInputSoon(); });

    // Initial render
    render();
    focusScanInputSoon();
  </script>
</body>
</html>
