<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stock Scanner POS (HTML) - Admin + PR Access</title>
  <style>
    :root {
      --primary: #1976d2;
      --primary-dark: #1565c0;
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --green: #2e7d32;
      --red: #c62828;
      --border: #e5e7eb;
      --chip1: #1976d2;
      --chip2: #1565c0;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"; background: var(--bg); color: var(--text); }

    .topbar { background: var(--primary); color: #fff; padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .topbar .left { display: flex; align-items: center; gap: 12px; }
    .title { font-weight: 600; font-size: 18px; }
    .chip { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 999px; font-size: 12px; font-weight: 600; }
    .chip.sku { background: var(--chip1); color: white; }
    .chip.units { background: var(--chip2); color: white; }
    .top-actions { display: flex; align-items: center; gap: 8px; }
    .btn { appearance: none; border: 1px solid transparent; padding: 8px 12px; border-radius: 8px; background: #fff; color: var(--text); cursor: pointer; font-weight: 600; font-size: 14px; }
    .btn:hover { filter: brightness(0.98); }
    .btn.primary { background: #fff1; color: #fff; border-color: #ffffff44; }
    .btn.primary:hover { background: #ffffff1f; }
    .btn.outline { background: transparent; border-color: #ffffff66; color: #fff; }
    .btn.danger { background: #ffffff0f; border-color: #ffffff33; color: #ffd1d1; }
    .btn.small { padding: 4px 8px; font-size: 12px; }

    .container { padding: 16px; max-width: 1200px; margin: 0 auto; }
    .banner { margin: 12px 16px; padding: 10px 12px; border: 1px solid #f59e0b; background: #fff7ed; color: #92400e; border-radius: 8px; }
    .hidden { display: none !important; }

    .tabs { display: flex; gap: 8px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 4px; }
    .tab { flex: 1; padding: 10px; text-align: center; border: 1px solid transparent; border-radius: 6px; background: transparent; cursor: pointer; font-weight: 600; color: var(--muted); }
    .tab.active { background: var(--primary); color: #fff; }

    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 5fr 7fr; } }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
    .card h3 { margin: 0 0 8px 0; font-size: 18px; }
    .muted { color: var(--muted); font-size: 14px; }

    .row { display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }
    label { font-size: 13px; color: var(--muted); }
    input[type="text"], input[type="number"], input[type="search"], input[type="file"], input[type="datetime-local"], input[type="password"] {
      width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; outline: none; font-size: 14px; background: #fff;
    }
    input[type="number"] { text-align: right; }

    .mode-switch { display: inline-flex; gap: 8px; background: #f1f5f9; padding: 4px; border-radius: 8px; border: 1px solid var(--border); }
    .mode-switch .seg { padding: 6px 10px; border-radius: 6px; cursor: pointer; font-weight: 600; color: var(--muted); }
    .mode-switch .seg.active { background: var(--primary); color: #fff; }

    .prefs { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
    .prefs .chk { display: inline-flex; align-items: center; gap: 6px; font-size: 14px; color: var(--text); }

    .table-wrap { max-height: 420px; overflow: auto; border: 1px solid var(--border); border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    thead th { position: sticky; top: 0; background: #f8fafc; border-bottom: 1px solid var(--border); text-align: left; padding: 8px; }
    tbody td { border-bottom: 1px solid var(--border); padding: 8px; vertical-align: middle; }
    tbody tr:hover { background: #fafafa; }

    .actions { display: flex; justify-content: flex-end; align-items: center; gap: 6px; }
    .badge { display: inline-block; padding: 6px 8px; border-radius: 8px; border: 1px solid var(--border); }
    .last-scan { border: 1px solid var(--border); border-radius: 8px; padding: 10px; }

    dialog::backdrop { background: rgb(0 0 0 / 0.4); }
    dialog { border: none; border-radius: 12px; padding: 0; }
    .dlg { padding: 16px; }
    .dlg header { padding: 16px; border-bottom: 1px solid var(--border); font-weight: 700; }
    .dlg .body { padding: 16px; }
    .dlg .footer { padding: 16px; display: flex; justify-content: flex-end; gap: 8px; border-top: 1px solid var(--border); }

    .toast { position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%) translateY(20px); padding: 10px 14px; background: #111827; color: #fff; border-radius: 999px; opacity: 0; transition: all 0.25s ease; pointer-events: none; font-size: 14px; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* Auth overlay */
    .auth-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(17, 24, 39, 0.7); z-index: 9999; }
    .auth-card { width: 340px; max-width: 90vw; background: var(--card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); padding: 16px; }
    .auth-card h3 { margin: 0 0 6px 0; font-size: 18px; }
    .auth-row { display: flex; gap: 8px; margin-top: 10px; }
    .auth-row input[type="password"] { flex: 1; }
    .auth-error { color: var(--red); font-size: 13px; margin-top: 8px; display: none; }

    /* Image thumbnails */
    .namecell { display: flex; align-items: center; gap: 8px; }
    .thumbbox { width: 36px; height: 36px; flex: 0 0 36px; border: 1px solid var(--border); border-radius: 6px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .thumb { display: block; width: 100%; height: 100%; object-fit: cover; }
    .previewbox { width: 48px; height: 48px; border: 1px solid var(--border); border-radius: 8px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .previewbox img { max-width: 100%; max-height: 100%; display: none; }

    /* PR Cart */
    .cart-summary { display: flex; align-items: center; gap: 12px; justify-content: space-between; flex-wrap: wrap; }
    .muted-small { color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <div id="authOverlay" class="auth-overlay" aria-modal="true" role="dialog">
    <div class="auth-card">
      <h3>Password Required</h3>
      <div class="muted">Enter password to unlock</div>
      <div class="auth-row">
        <input type="password" id="authPwd" placeholder="Password" autocomplete="current-password" />
        <button class="btn" id="authUnlockBtn" style="background: var(--primary); color: #fff;">Unlock</button>
      </div>
      <div class="muted-small" style="margin-top:6px;">Admin: best2510store â€¢ PR: 2510</div>
      <div class="auth-error" id="authError">Incorrect password. Try again.</div>
    </div>
  </div>

  <div class="topbar">
    <div class="left">
      <button class="btn outline small" id="switchUserBtn" title="Lock and switch user">Switch User</button>
      <div class="title">Stock Scanner</div>
      <span class="chip sku" id="skuChip">SKUs: <span id="skuCount">0</span></span>
      <span class="chip units" id="unitsChip">Units: <span id="unitCount">0</span></span>
      <span class="chip" id="roleChip" style="background:#0f172a; color:#c7d2fe; display:none;">PR Mode</span>
    </div>
    <div class="top-actions" id="topActions">
      <label class="switch"><input type="checkbox" id="soundChk"> <span style="color:#fff">Scan sound</span></label>
      <button class="btn outline" id="exportBtn">Export</button>
      <button class="btn outline" id="importBtn">Import</button>
      <button class="btn outline" id="demoBtn">Demo</button>
      <button class="btn danger" id="clearBtn">Clear</button>
    </div>
  </div>

  <div id="storageBanner" class="banner hidden">Local storage is blocked in this browser. Data will not persist across refreshes.</div>

  <div class="container">
    <div class="tabs" style="margin-bottom: 12px;">
      <button class="tab active" id="tabBtn-scan">Scan</button>
      <button class="tab" id="tabBtn-inventory">Inventory</button>
      <button class="tab" id="tabBtn-movements">Movements</button>
      <button class="tab" id="tabBtn-removals">Removals</button>
      <button class="tab" id="tabBtn-requests">Requests</button>
    </div>

    <div id="tab-scan" class="tab-panel">
      <div class="grid">
        <div class="card">
          <h3 id="scanTitle">Scan with barcode scanner</h3>
          <div class="muted" id="scanSubtitle" style="margin-bottom: 12px;">Click inside the input, then scan. Most USB scanners type the code and send Enter.</div>
          <div class="row" style="margin-bottom: 12px; align-items: center;">
            <div class="mode-switch" id="modeSwitch">
              <div class="seg active" data-mode="add">Add Stock</div>
              <div class="seg" data-mode="remove">Remove Stock</div>
            </div>
            <div class="prefs" id="prefsRow">
              <label class="chk"><input type="checkbox" id="autoResetQtyChk" checked> Auto reset qty</label>
              <label class="chk"><input type="checkbox" id="allowNegativeChk"> Allow negative</label>
            </div>
          </div>
          <div class="row">
            <div style="flex: 1; min-width: 260px;">
              <label id="scanInputLabel">Scan barcode (press Enter)</label>
              <input type="text" id="scanCodeInput" placeholder="Scan or type code and press Enter" />
            </div>
            <div style="width: 140px;">
              <label>Qty</label>
              <input type="number" id="scanQtyInput" min="1" value="1" />
            </div>
            <div>
              <button class="btn" id="applyScanBtn" style="background: var(--primary); color: #fff;">Apply</button>
            </div>
          </div>

          <div id="lastResultBox" class="last-scan" style="margin-top: 14px; display: none;"></div>
        </div>

        <!-- Admin: Inventory card -->
        <div class="card" id="invCard">
          <div class="row" style="justify-content: space-between; margin-bottom: 8px; align-items: center;">
            <h3 style="margin:0">Inventory</h3>
            <div style="width: 260px;">
              <input type="search" id="searchInput" placeholder="Search by SKU or name" />
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="width: 200px;">SKU</th>
                  <th>Name</th>
                  <th style="width: 120px; text-align: right;">Stock</th>
                  <th style="width: 120px; text-align: right;">Price</th>
                  <th style="width: 200px; text-align: right;">Actions</th>
                </tr>
              </thead>
              <tbody id="inventoryTableBody"></tbody>
            </table>
          </div>
          <div style="margin-top: 10px;">
            <button class="btn" id="addRowBtn">Add Row</button>
          </div>
        </div>

        <!-- PR: Request Cart card -->
        <div class="card hidden" id="prCard">
          <div class="row" style="justify-content: space-between; margin-bottom: 8px; align-items: center;">
            <h3 style="margin:0">PR Request Cart</h3>
            <div class="cart-summary">
              <div class="muted">Items in cart: <span id="prCartCount">0</span></div>
              <div>
                <button class="btn" id="prClearBtn">Clear</button>
                <button class="btn" id="prSubmitBtn" style="background: var(--green); color:#fff;">Submit Request</button>
              </div>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="width: 200px;">SKU</th>
                  <th>Name</th>
                  <th style="width: 110px; text-align: right;">Qty</th>
                  <th style="width: 120px; text-align: right;">Actions</th>
                </tr>
              </thead>
              <tbody id="prCartTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div id="tab-inventory" class="tab-panel hidden">
      <div class="card">
        <div class="row" style="justify-content: space-between; margin-bottom: 8px; align-items: center;">
          <h3 style="margin:0">Inventory</h3>
          <div style="width: 260px;">
            <input type="search" id="searchInput2" placeholder="Search by SKU or name" />
          </div>
        </div>
        <div class="table-wrap" style="max-height: 560px;">
          <table>
            <thead>
              <tr>
                <th style="width: 200px;">SKU</th>
                <th>Name</th>
                <th style="width: 120px; text-align: right;">Stock</th>
                <th style="width: 120px; text-align: right;">Price</th>
                <th style="width: 200px; text-align: right;">Actions</th>
              </tr>
            </thead>
            <tbody id="inventoryTableBody2"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="tab-movements" class="tab-panel hidden">
      <div class="card">
        <h3>Movements (latest 1000)</h3>
        <div class="table-wrap" style="max-height: 560px;">
          <table>
            <thead>
              <tr>
                <th style="width: 220px;">Time</th>
                <th style="width: 200px;">SKU</th>
                <th>Name</th>
                <th style="width: 100px; text-align: right;">Qty</th>
                <th style="width: 120px; text-align: right;">Change</th>
              </tr>
            </thead>
            <tbody id="movementsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="tab-removals" class="tab-panel hidden">
      <div class="card">
        <h3>Removed Stock</h3>
        <div class="table-wrap" style="max-height: 560px;">
          <table>
            <thead>
              <tr>
                <th style="width: 220px;">Time</th>
                <th style="width: 200px;">SKU</th>
                <th>Name</th>
                <th style="width: 100px; text-align: right;">Qty</th>
              </tr>
            </thead>
            <tbody id="removalsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="tab-requests" class="tab-panel hidden">
      <div class="card">
        <h3>PR Requests</h3>
        <div class="table-wrap" style="max-height: 560px;">
          <table>
            <thead>
              <tr>
                <th style="width: 220px;">Time</th>
                <th style="width: 220px;">Request ID</th>
                <th>Summary</th>
                <th style="width: 120px; text-align:right;">Items</th>
              </tr>
            </thead>
            <tbody id="requestsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <dialog id="createDialog">
    <div class="dlg">
      <header>New item from scan</header>
      <div class="body">
        <div class="muted" style="margin-bottom: 8px;">Scanned code not found. Create an item to attach to this code.</div>
        <div style="margin-bottom: 8px;">
          <label>SKU / Barcode</label>
          <input type="text" id="pendingCodeInput" />
        </div>
        <div style="margin-bottom: 8px;">
          <label>Name</label>
          <input type="text" id="newItemNameInput" />
        </div>
        <div style="margin-bottom: 8px;">
          <label>Price (optional)</label>
          <input type="text" id="newItemPriceInput" />
        </div>
        <div style="margin-bottom: 8px;">
          <label>Image (optional)</label>
          <div class="row" style="align-items:center;">
            <input type="file" id="newItemImageInput" accept="image/*" />
            <div class="previewbox">
              <img id="newItemImagePreview" alt="preview" />
            </div>
          </div>
        </div>
      </div>
      <div class="footer">
        <button class="btn" id="createCancelBtn">Cancel</button>
        <button class="btn" id="createSaveApplyBtn" style="background: var(--primary); color: #fff;">Save & Apply Scan</button>
      </div>
    </div>
  </dialog>

  <input type="file" id="importFile" accept=".csv" class="hidden" />
  <div id="toast" class="toast"></div>

  <script>
    // ---------------- Utilities ----------------
    function makeStorage() {
      try { const k = '__probe__'; localStorage.setItem(k, '1'); localStorage.removeItem(k); return localStorage; }
      catch (e) { const mem = {}; return { getItem: (k) => (k in mem ? mem[k] : null), setItem: (k, v) => { mem[k] = String(v); }, removeItem: (k) => { delete mem[k]; } }; }
    }
    const storage = makeStorage();
    const STORAGE_KEYS = { items: 'ssi_items', movements: 'ssi_movements', prefs: 'ssi_prefs', requests: 'ssi_requests', prcart: 'ssi_prcart' };

    function loadJSON(key, fallback) { try { const raw = storage.getItem(key); if (!raw) return fallback; return JSON.parse(raw); } catch { return fallback; } }
    function saveJSON(key, val) { try { storage.setItem(key, JSON.stringify(val)); return true; } catch { return false; } }
    function uid(prefix = 'id') { return prefix + '_' + Math.random().toString(36).slice(2, 10); }
    function nowIso() { return new Date().toISOString(); }
    function humanDate(iso) { try { return new Date(iso).toLocaleString(); } catch { return iso; } }
    function sumUnits(items) { return items.reduce((s, it) => s + (Number(it.stock) || 0), 0); }
    function showToast(msg) { const el = document.getElementById('toast'); el.textContent = msg; el.classList.add('show'); clearTimeout(showToast._t); showToast._t = setTimeout(() => el.classList.remove('show'), 2500); }

    function toCSV(items) {
      const header = ['sku','name','stock','price'];
      const lines = [header.join(',')];
      for (const it of items) {
        const row = [it.sku, it.name, it.stock, it.price ?? ''];
        const escaped = row.map(v => { const s = String(v ?? ''); return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s; });
        lines.push(escaped.join(','));
      }
      return lines.join('\n');
    }
    function download(filename, text, mime='text/plain') {
      const blob = new Blob([text], { type: mime + ';charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    // Image file -> dataURL (resized)
    function fileToDataURL(file, maxW = 256, maxH = 256) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(new Error('Failed to read image'));
        reader.onload = () => {
          const url = reader.result;
          const img = new Image();
          img.onload = () => {
            let w = img.width, h = img.height;
            if (w > maxW || h > maxH) {
              const scale = Math.min(maxW / w, maxH / h);
              w = Math.max(1, Math.round(w * scale));
              h = Math.max(1, Math.round(h * scale));
              const canvas = document.createElement('canvas');
              canvas.width = w; canvas.height = h;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, w, h);
              resolve(canvas.toDataURL('image/jpeg', 0.8));
            } else { resolve(url); }
          };
          img.onerror = () => resolve(url);
          img.src = url;
        };
        reader.readAsDataURL(file);
      });
    }

    // Web Audio beep
    let audioCtx = null;
    function ensureAudioCtx() { if (!audioCtx) { try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch {} } return audioCtx; }
    function beep(freq = 880, ms = 80) {
      if (!state.prefs.sound) return;
      const ctx = ensureAudioCtx(); if (!ctx) return;
      const osc = ctx.createOscillator(); const gain = ctx.createGain();
      osc.type = 'sine'; osc.frequency.value = freq; gain.gain.value = 0.02;
      osc.connect(gain).connect(ctx.destination);
      const t = ctx.currentTime; osc.start(t); osc.stop(t + ms/1000);
    }

    // ---------------- State ----------------
    const state = {
      role: null, // 'admin' | 'pr'
      items: loadJSON(STORAGE_KEYS.items, [
        { id: uid('sku'), sku: '012345678905', name: 'Demo Widget A', stock: 12, price: 9.99, image: '' },
        { id: uid('sku'), sku: '012345678906', name: 'Demo Widget B', stock: 8, price: 14.5, image: '' },
        { id: uid('sku'), sku: 'ABC123', name: 'Demo Part C', stock: 20, price: 4.25, image: '' },
      ]),
      movements: loadJSON(STORAGE_KEYS.movements, []),
      prefs: loadJSON(STORAGE_KEYS.prefs, { allowNegative: false, autoResetQty: true, sound: false }),
      requests: loadJSON(STORAGE_KEYS.requests, []),
      prCart: loadJSON(STORAGE_KEYS.prcart, []),
      search: '',
      tab: 'scan',
      mode: 'add',
      scanCode: '',
      scanQty: 1,
      lastScan: null,
      storageOk: true,
      pendingCode: '',
      pendingApply: false,
      newItemImageData: '',
    };

    (function(){ try { state.storageOk = saveJSON('__probe__', { t: Date.now() }); } catch { state.storageOk = false; } })();

    // ---------------- DOM Refs ----------------
    const skuCountEl = document.getElementById('skuCount');
    const unitCountEl = document.getElementById('unitCount');
    const skuChip = document.getElementById('skuChip');
    const unitsChip = document.getElementById('unitsChip');
    const roleChip = document.getElementById('roleChip');
    const storageBanner = document.getElementById('storageBanner');

    const tabBtnScan = document.getElementById('tabBtn-scan');
    const tabBtnInv = document.getElementById('tabBtn-inventory');
    const tabBtnMov = document.getElementById('tabBtn-movements');
    const tabBtnRem = document.getElementById('tabBtn-removals');
    const tabBtnReq = document.getElementById('tabBtn-requests');
    const tabScan = document.getElementById('tab-scan');
    const tabInv = document.getElementById('tab-inventory');
    const tabMov = document.getElementById('tab-movements');
    const tabRem = document.getElementById('tab-removals');
    const tabReq = document.getElementById('tab-requests');

    const topActions = document.getElementById('topActions');

    const soundChk = document.getElementById('soundChk');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const demoBtn = document.getElementById('demoBtn');
    const clearBtn = document.getElementById('clearBtn');

    const searchInput = document.getElementById('searchInput');
    const searchInput2 = document.getElementById('searchInput2');

    const modeSwitch = document.getElementById('modeSwitch');
    const prefsRow = document.getElementById('prefsRow');
    const autoResetQtyChk = document.getElementById('autoResetQtyChk');
    const allowNegativeChk = document.getElementById('allowNegativeChk');

    const scanTitle = document.getElementById('scanTitle');
    const scanSubtitle = document.getElementById('scanSubtitle');
    const scanInputLabel = document.getElementById('scanInputLabel');
    const scanCodeInput = document.getElementById('scanCodeInput');
    const scanQtyInput = document.getElementById('scanQtyInput');
    const applyScanBtn = document.getElementById('applyScanBtn');
    const lastResultBox = document.getElementById('lastResultBox');

    const invCard = document.getElementById('invCard');
    const invTbody1 = document.getElementById('inventoryTableBody');
    const invTbody2 = document.getElementById('inventoryTableBody2');
    const addRowBtn = document.getElementById('addRowBtn');

    const movTbody = document.getElementById('movementsTableBody');
    const remTbody = document.getElementById('removalsTableBody');
    const reqTbody = document.getElementById('requestsTableBody');

    const prCard = document.getElementById('prCard');
    const prCartTbody = document.getElementById('prCartTbody');
    const prCartCount = document.getElementById('prCartCount');
    const prSubmitBtn = document.getElementById('prSubmitBtn');
    const prClearBtn = document.getElementById('prClearBtn');

    const createDialog = document.getElementById('createDialog');
    const pendingCodeInput = document.getElementById('pendingCodeInput');
    const newItemNameInput = document.getElementById('newItemNameInput');
    const newItemPriceInput = document.getElementById('newItemPriceInput');
    const newItemImageInput = document.getElementById('newItemImageInput');
    const newItemImagePreview = document.getElementById('newItemImagePreview');
    const createCancelBtn = document.getElementById('createCancelBtn');
    const createSaveApplyBtn = document.getElementById('createSaveApplyBtn');

    const authOverlay = document.getElementById('authOverlay');
    const switchUserBtn = document.getElementById('switchUserBtn');
    const authPwd = document.getElementById('authPwd');
    const authUnlockBtn = document.getElementById('authUnlockBtn');
    const authError = document.getElementById('authError');

    // ---------------- Helpers ----------------
    function saveAll() { saveJSON(STORAGE_KEYS.items, state.items); saveJSON(STORAGE_KEYS.movements, state.movements); saveJSON(STORAGE_KEYS.prefs, state.prefs); saveJSON(STORAGE_KEYS.requests, state.requests); saveJSON(STORAGE_KEYS.prcart, state.prCart); }
    function setItems(fnOrArr) { state.items = typeof fnOrArr === 'function' ? fnOrArr(state.items) : fnOrArr; saveJSON(STORAGE_KEYS.items, state.items); render(); }
    function setMovements(fnOrArr) { state.movements = typeof fnOrArr === 'function' ? fnOrArr(state.movements) : fnOrArr; saveJSON(STORAGE_KEYS.movements, state.movements); render(); }
    function setPrefs(patch) { state.prefs = { ...state.prefs, ...patch }; saveJSON(STORAGE_KEYS.prefs, state.prefs); render(); }

    function findItemBySku(code) { const c = String(code || '').trim().toLowerCase(); if (!c) return null; return state.items.find(it => String(it.sku).trim().toLowerCase() === c) || null; }
    function findItemById(id) { return state.items.find(it => it.id === id); }
    function upsertItem(obj) {
      const key = String(obj.sku).trim().toLowerCase();
      let found = false;
      const next = state.items.map(it => {
        if (String(it.sku).trim().toLowerCase() === key) { found = true; return { ...it, ...obj }; }
        return it;
      });
      if (!found) next.unshift({ id: uid('sku'), stock: 0, price: '', image: '', ...obj });
      setItems(next);
    }
    function recordMovement({ sku, name, qty, mode }) { const delta = mode === 'add' ? qty : -qty; setMovements(prev => [{ id: uid('mv'), ts: nowIso(), sku, name, qty, mode, delta }, ...prev].slice(0, 1000)); }

    function focusScanInputSoon() { setTimeout(() => { scanCodeInput.focus(); scanCodeInput.select && scanCodeInput.select(); }, 0); }

    // ----- Admin stock processing -----
    function processScan(code, qty) {
      if (state.role === 'pr') { return processPRScan(code, qty); }
      const clean = String(code || '').trim();
      const nQty = Math.max(1, parseInt(qty, 10) || 1);
      if (!clean) { showToast('Scan a code first.'); return; }
      const found = findItemBySku(clean);
      if (!found) {
        state.pendingCode = clean; state.pendingApply = true; openCreateDialog(); beep(440, 160); return;
      }
      const delta = state.mode === 'add' ? nQty : -nQty;
      const allowNeg = !!state.prefs.allowNegative;
      state.items = state.items.map(it => {
        if (it.id !== found.id) return it;
        const nextStock = (Number(it.stock) || 0) + delta;
        return { ...it, stock: allowNeg ? nextStock : Math.max(0, nextStock) };
      });
      saveJSON(STORAGE_KEYS.items, state.items);
      recordMovement({ sku: found.sku, name: found.name, qty: nQty, mode: state.mode });
      state.lastScan = { sku: found.sku, name: found.name, qty: nQty, delta, stockAfter: (Number(found.stock)||0) + delta, image: found.image || '' };
      render();
      showToast((state.mode === 'add' ? 'Added ' : 'Removed ') + nQty + ' â€¢ ' + found.name + ' (' + found.sku + ')');
      beep(880, 80);
      if (state.prefs.autoResetQty) state.scanQty = 1;
      state.scanCode = '';
      renderScanInputs();
      focusScanInputSoon();
    }

    // ----- PR processing -----
    function savePrCart() { saveJSON(STORAGE_KEYS.prcart, state.prCart); }
    function prAddItem(sku, name, qty, image) {
      const key = String(sku).trim().toLowerCase();
      let found = state.prCart.find(x => String(x.sku).trim().toLowerCase() === key);
      if (found) { found.qty += qty; }
      else { state.prCart.unshift({ sku, name, qty, image: image || '' }); }
      savePrCart();
    }
    function processPRScan(code, qty) {
      const clean = String(code || '').trim();
      const nQty = Math.max(1, parseInt(qty, 10) || 1);
      if (!clean) { showToast('Scan a code first.'); return; }
      const found = findItemBySku(clean);
      if (!found) { showToast('Item not found. Ask admin to add it.'); beep(220, 160); return; }
      prAddItem(found.sku, found.name, nQty, found.image || '');
      state.lastScan = { sku: found.sku, name: found.name, qty: nQty, delta: nQty, stockAfter: null, image: found.image || '' };
      render();
      showToast('Added to request: ' + nQty + ' â€¢ ' + found.name);
      beep(880, 80);
      if (state.prefs.autoResetQty) state.scanQty = 1;
      state.scanCode = '';
      renderScanInputs();
      focusScanInputSoon();
    }

    function submitPR() {
      if (!state.prCart.length) { showToast('Cart is empty'); return; }
      const req = { id: uid('req'), ts: nowIso(), items: state.prCart.map(x => ({ sku: x.sku, name: x.name, qty: x.qty })) };
      state.requests = [{ id: req.id, ts: req.ts, items: req.items }, ...state.requests];
      state.prCart = [];
      saveAll();
      render();
      showToast('Request submitted: ' + req.id);
    }

    function clearPRCart() { if (!state.prCart.length) return; if (!confirm('Clear the request cart?')) return; state.prCart = []; savePrCart(); render(); }

    // ----- Create Dialog -----
    function openCreateDialog() { if (state.role === 'pr') { showToast('Item not found. Ask admin to add it.'); return; }
      pendingCodeInput.value = state.pendingCode; newItemNameInput.value = ''; newItemPriceInput.value = ''; state.newItemImageData = '';
      if (newItemImagePreview) { newItemImagePreview.src = ''; newItemImagePreview.style.display = 'none'; }
      try { createDialog.showModal(); } catch { createDialog.setAttribute('open',''); }
      pendingCodeInput.focus();
    }
    function closeCreateDialog() { try { createDialog.close(); } catch { createDialog.removeAttribute('open'); } }
    function handleCreateSave(applyScan = true) {
      const sku = pendingCodeInput.value.trim();
      const name = newItemNameInput.value.trim() || ('Item ' + sku);
      const price = newItemPriceInput.value.trim();
      const image = state.newItemImageData || '';
      upsertItem({ sku, name, price, image, stock: 0 });
      closeCreateDialog();
      showToast('Created item ' + name + ' (' + sku + ')');
      if (applyScan && state.pendingApply) { const qty = state.scanQty; setTimeout(() => processScan(sku, qty), 0); }
    }

    function adjustItemStock(id, delta) {
      const allowNeg = !!state.prefs.allowNegative;
      state.items = state.items.map(it => { if (it.id !== id) return it; const nextStock = (Number(it.stock) || 0) + delta; return { ...it, stock: allowNeg ? nextStock : Math.max(0, nextStock) }; });
      saveJSON(STORAGE_KEYS.items, state.items);
      render();
    }
    function setItemField(id, field, value) { state.items = state.items.map(it => it.id === id ? { ...it, [field]: field === 'stock' ? (parseInt(value, 10) || 0) : value } : it); saveJSON(STORAGE_KEYS.items, state.items); render(); }
    function deleteItem(id) { if (!confirm('Delete this item?')) return; state.items = state.items.filter(it => it.id !== id); saveJSON(STORAGE_KEYS.items, state.items); render(); }

    function filteredItems() { const q = String(state.search || '').trim().toLowerCase(); if (!q) return state.items; return state.items.filter(it => String(it.sku).toLowerCase().includes(q) || String(it.name).toLowerCase().includes(q)); }

    function importCSVFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const text = String(e.target.result || '');
          const lines = text.split(/\r?\n/).filter(Boolean);
          if (lines.length === 0) throw new Error('Empty file');
          let startIdx = 0;
          const header = lines[0].split(',').map(h => h.trim().toLowerCase());
          if (header.includes('sku') && header.includes('name')) startIdx = 1;
          const incoming = [];
          for (let i = startIdx; i < lines.length; i++) {
            const raw = lines[i];
            const parts = raw.split(',');
            const sku = (parts[0] || '').trim();
            const name = (parts[1] || '').trim();
            const stock = Number(parts[2] || '0') || 0;
            const price = (parts[3] || '').trim();
            if (sku && name) incoming.push({ sku, name, stock, price });
          }
          if (incoming.length === 0) throw new Error('No valid rows');
          const map = new Map(state.items.map(it => [String(it.sku).toLowerCase(), it]));
          for (const inc of incoming) {
            const key = String(inc.sku).toLowerCase();
            if (map.has(key)) map.set(key, { ...map.get(key), ...inc }); else map.set(key, { id: uid('sku'), stock: 0, price: '', image: '', ...inc });
          }
          state.items = Array.from(map.values());
          saveJSON(STORAGE_KEYS.items, state.items);
          render();
          showToast('Imported ' + incoming.length + ' item(s)');
        } catch (err) { showToast('Import failed: ' + (err.message || err)); }
      };
      reader.onerror = () => showToast('Failed to read file');
      reader.readAsText(file);
    }

    function loadDemo() {
      if (!confirm('Load demo items? This merges with your current items.')) return;
      const demos = [
        { sku: '012345678905', name: 'Demo Widget A', stock: 12, price: 9.99, image: '' },
        { sku: '012345678906', name: 'Demo Widget B', stock: 8, price: 14.5, image: '' },
        { sku: 'ABC123', name: 'Demo Part C', stock: 20, price: 4.25, image: '' },
      ];
      const map = new Map(state.items.map(it => [String(it.sku).toLowerCase(), it]));
      for (const it of demos) { const k = String(it.sku).toLowerCase(); if (!map.has(k)) map.set(k, { id: uid('sku'), ...it }); }
      state.items = Array.from(map.values());
      saveJSON(STORAGE_KEYS.items, state.items);
      render();
      showToast('Demo items loaded');
    }

    function clearAll() { if (!confirm('Clear all inventory, movements, and requests?')) return; state.items = []; state.movements = []; state.requests = []; state.prCart = []; saveAll(); render(); showToast('Cleared all data'); }

    // ---------------- Renderers ----------------
    function render() {
      // Top counters and role chip
      skuCountEl.textContent = String(state.items.length);
      unitCountEl.textContent = String(sumUnits(state.items));
      roleChip.style.display = state.role === 'pr' ? 'inline-flex' : 'none';
      storageBanner.classList.toggle('hidden', !!state.storageOk);

      // Tabs visibility based on role
      const isPR = state.role === 'pr';
      tabBtnInv.style.display = ''; // PR can view inventory (read-only)
      tabBtnMov.style.display = isPR ? 'none' : '';
      tabBtnRem.style.display = isPR ? 'none' : '';
      tabBtnReq.style.display = isPR ? 'none' : '';

      topActions.style.display = isPR ? 'none' : 'flex';
      skuChip.style.display = isPR ? 'none' : 'inline-flex';
      unitsChip.style.display = isPR ? 'none' : 'inline-flex';

      // if PR and current tab would be hidden, snap to scan (allow scan + inventory)
      if (isPR && !['scan','inventory'].includes(state.tab)) state.tab = 'scan';

      // Set active tabs
      tabBtnScan.classList.toggle('active', state.tab === 'scan');
      tabBtnInv.classList.toggle('active', state.tab === 'inventory');
      tabBtnMov.classList.toggle('active', state.tab === 'movements');
      tabBtnRem.classList.toggle('active', state.tab === 'removals');
      tabBtnReq.classList.toggle('active', state.tab === 'requests');
      tabScan.classList.toggle('hidden', state.tab !== 'scan');
      tabInv.classList.toggle('hidden', state.tab !== 'inventory');
      tabMov.classList.toggle('hidden', state.tab !== 'movements');
      tabRem.classList.toggle('hidden', state.tab !== 'removals');
      tabReq.classList.toggle('hidden', state.tab !== 'requests');

      // Scan header and controls depending on role
      if (isPR) {
        scanTitle.textContent = 'PR: Scan items to request';
        scanSubtitle.textContent = 'Scan an item barcode to add it to your request cart.';
        scanInputLabel.textContent = 'Scan barcode to add to request';
        modeSwitch.style.display = 'none';
        prefsRow.style.display = 'none';
        invCard.classList.add('hidden');
        prCard.classList.remove('hidden');
      } else {
        scanTitle.textContent = 'Scan with barcode scanner';
        scanSubtitle.textContent = 'Click inside the input, then scan. Most USB scanners type the code and send Enter.';
        scanInputLabel.textContent = 'Scan barcode (press Enter)';
        modeSwitch.style.display = '';
        prefsRow.style.display = '';
        invCard.classList.remove('hidden');
        prCard.classList.add('hidden');
      }

      // scan mode segments
      Array.from(modeSwitch.querySelectorAll('.seg')).forEach(seg => seg.classList.toggle('active', seg.dataset.mode === state.mode));

      // prefs
      autoResetQtyChk.checked = !!state.prefs.autoResetQty;
      allowNegativeChk.checked = !!state.prefs.allowNegative;
      soundChk.checked = !!state.prefs.sound;

      // search inputs
      if (document.activeElement !== searchInput) searchInput.value = state.search;
      if (document.activeElement !== searchInput2) searchInput2.value = state.search;

      // inventory tables
      renderInventory(invTbody1);
      renderInventory(invTbody2);

      // movements & removals
      renderMovements();
      renderRemovals();
      renderRequests();

      // last scan box
      renderLastScan();

      // scan inputs
      renderScanInputs();

      // PR cart
      renderPrCart();
    }

    function renderScanInputs() { if (document.activeElement !== scanCodeInput) scanCodeInput.value = state.scanCode; if (document.activeElement !== scanQtyInput) scanQtyInput.value = state.scanQty; }

    function renderLastScan() {
      if (!state.lastScan) { lastResultBox.style.display = 'none'; return; }
      const r = state.lastScan;
      const green = state.role === 'pr' ? true : (r.delta >= 0);
      lastResultBox.style.display = 'block';
      lastResultBox.style.background = green ? '#e8f5e9' : '#ffebee';
      lastResultBox.style.borderColor = green ? '#a5d6a7' : '#ef9a9a';
      const imgHtml = r.image ? `<div class="thumbbox" style="width:48px;height:48px;"><img class="thumb" src="${r.image}" alt="img" /></div>` : '';
      const actionLabel = state.role === 'pr' ? 'Requested' : (r.delta >= 0 ? 'Added' : 'Removed');
      const stockAfterLine = state.role === 'pr' ? '' : `<div class="muted">Stock after: ${r.stockAfter}</div>`;
      lastResultBox.innerHTML = `
        <div class="muted">Last ${state.role === 'pr' ? 'request add' : 'scan'}</div>
        <div style="display:flex; gap:10px; align-items:center;">
          ${imgHtml}
          <div>
            <div style="font-size: 16px; font-weight: 600;">${actionLabel} ${Math.abs(r.delta)} â€¢ ${r.name} (${r.sku})</div>
            ${stockAfterLine}
          </div>
        </div>
      `;
    }

    function escapeHtml(s) { return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    function renderInventory(tbody) {
      const list = filteredItems();
      if (!tbody) return;
      const isPR = state.role === 'pr';
      if (list.length === 0) { tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: var(--muted); padding: 16px;">No items. Scan to add, import CSV, or click Demo.</td></tr>`; return; }

      if (isPR) {
        // Read-only view for PR with ability to add to PR cart
        tbody.innerHTML = list.map(it => `
          <tr data-sku="${escapeHtml(it.sku)}">
            <td>${escapeHtml(it.sku)}</td>
            <td>
              <div class="namecell">
                <div class="thumbbox">${it.image ? `<img class="thumb" src="${escapeHtml(it.image)}" alt="" />` : ''}</div>
                ${escapeHtml(it.name)}
              </div>
            </td>
            <td style="text-align: right;">${Number(it.stock) || 0}</td>
            <td style="text-align: right;">${escapeHtml(it.price ?? '')}</td>
            <td style="text-align: right;">
              <div class="actions">
                <input type="number" class="pr-inv-qty" value="1" min="1" style="width: 80px; text-align: right;" />
                <button class="btn small pr-inv-add">Add</button>
              </div>
            </td>
          </tr>
        `).join('');

        // Attach PR handlers
        tbody.querySelectorAll('tr').forEach(tr => {
          const sku = tr.getAttribute('data-sku');
          const btnAdd = tr.querySelector('.pr-inv-add');
          const qtyInp = tr.querySelector('.pr-inv-qty');
          btnAdd.addEventListener('click', () => {
            const qty = Math.max(1, parseInt(qtyInp.value, 10) || 1);
            const item = findItemBySku(sku);
            if (!item) { showToast('Item not found'); return; }
            prAddItem(item.sku, item.name, qty, item.image || '');
            renderPrCart();
            showToast('Added to request: ' + qty + ' â€¢ ' + item.name);
          });
        });
        return;
      }

      // Admin (editable) view
      tbody.innerHTML = list.map(it => `
        <tr data-id="${it.id}">
          <td><input type="text" class="inp sku" value="${escapeHtml(it.sku)}" /></td>
          <td>
            <div class="namecell">
              <div class="thumbbox">${it.image ? `<img class=\"thumb\" src=\"${escapeHtml(it.image)}\" alt=\"\" />` : ''}</div>
              <input type="text" class="inp name" value="${escapeHtml(it.name)}" />
            </div>
          </td>
          <td style="text-align: right;">
            <div class="actions" style="justify-content: flex-end;">
              <button class="btn small minus">-</button>
              <input type="number" class="inp stock" value="${Number(it.stock) || 0}" style="width: 80px;" />
              <button class="btn small plus">+</button>
            </div>
          </td>
          <td style="text-align: right;"><input type="text" class="inp price" value="${escapeHtml(it.price ?? '')}" style="width: 100px; text-align: right;" /></td>
          <td style="text-align: right;">
            <div class="actions">
              <button class="btn small quickAdd">+1</button>
              <button class="btn small quickRemove">-1</button>
              <button class="btn small danger del">Delete</button>
            </div>
          </td>
        </tr>
      `).join('');

      // attach handlers (Admin only)
      tbody.querySelectorAll('tr').forEach(tr => {
        const id = tr.getAttribute('data-id');
        const skuInp = tr.querySelector('.inp.sku');
        const nameInp = tr.querySelector('.inp.name');
        const stockInp = tr.querySelector('.inp.stock');
        const priceInp = tr.querySelector('.inp.price');
        const btnMinus = tr.querySelector('.minus');
        const btnPlus = tr.querySelector('.plus');
        const btnQuickAdd = tr.querySelector('.quickAdd');
        const btnQuickRemove = tr.querySelector('.quickRemove');
        const btnDel = tr.querySelector('.del');

        skuInp.addEventListener('change', () => setItemField(id, 'sku', skuInp.value));
        nameInp.addEventListener('change', () => setItemField(id, 'name', nameInp.value));
        stockInp.addEventListener('change', () => setItemField(id, 'stock', parseInt(stockInp.value, 10) || 0));
        priceInp.addEventListener('change', () => setItemField(id, 'price', priceInp.value));
        btnMinus.addEventListener('click', () => adjustItemStock(id, -1));
        btnPlus.addEventListener('click', () => adjustItemStock(id, +1));
        btnQuickAdd.addEventListener('click', () => { state.mode = 'add'; processScan(findItemById(id).sku, 1); });
        btnQuickRemove.addEventListener('click', () => { state.mode = 'remove'; processScan(findItemById(id).sku, 1); });
        btnDel.addEventListener('click', () => deleteItem(id));
      });
    }

    function renderMovements() {
      const rows = state.movements.map(mv => `
        <tr>
          <td>${escapeHtml(humanDate(mv.ts))}</td>
          <td>${escapeHtml(mv.sku)}</td>
          <td>${escapeHtml(mv.name)}</td>
          <td style="text-align: right;">${mv.qty}</td>
          <td style="text-align: right; color: ${mv.delta >= 0 ? 'var(--green)':'var(--red)'};">${mv.delta >= 0 ? '+' : ''}${mv.delta}</td>
        </tr>
      `).join('');
      movTbody.innerHTML = rows || `<tr><td colspan="5" style="text-align:center; color: var(--muted); padding: 16px;">No movements yet.</td></tr>`;
    }

    function renderRemovals() {
      const removed = state.movements.filter(mv => mv.delta < 0);
      const rows = removed.map(mv => `
        <tr>
          <td>${escapeHtml(humanDate(mv.ts))}</td>
          <td>${escapeHtml(mv.sku)}</td>
          <td>${escapeHtml(mv.name)}</td>
          <td style="text-align: right;">${mv.qty}</td>
        </tr>
      `).join('');
      remTbody.innerHTML = rows || `<tr><td colspan="4" style="text-align:center; color: var(--muted); padding: 16px;">No removals yet.</td></tr>`;
    }

    function renderRequests() {
      if (!reqTbody) return;
      const rows = state.requests.map(req => {
        const cnt = req.items.reduce((s, it) => s + (Number(it.qty)||0), 0);
        const summary = req.items.slice(0, 3).map(it => `${escapeHtml(it.name)} x${it.qty}`).join(', ') + (req.items.length > 3 ? 'â€¦' : '');
        return `
          <tr>
            <td>${escapeHtml(humanDate(req.ts))}</td>
            <td>${escapeHtml(req.id)}</td>
            <td>${summary || ''}</td>
            <td style="text-align:right;">${cnt}</td>
          </tr>
        `;
      }).join('');
      reqTbody.innerHTML = rows || `<tr><td colspan="4" style="text-align:center; color: var(--muted); padding: 16px;">No PR requests yet.</td></tr>`;
    }

    function renderPrCart() {
      if (!prCartTbody) return;
      prCartCount.textContent = String(state.prCart.length);
      if (state.prCart.length === 0) { prCartTbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color: var(--muted); padding: 16px;">Cart is empty. Scan items to add.</td></tr>`; return; }
      prCartTbody.innerHTML = state.prCart.map(row => `
        <tr data-sku="${escapeHtml(row.sku)}">
          <td>${escapeHtml(row.sku)}</td>
          <td>
            <div class="namecell">
              <div class="thumbbox">${row.image ? `<img class=\"thumb\" src=\"${escapeHtml(row.image)}\" alt=\"\" />` : ''}</div>
              ${escapeHtml(row.name)}
            </div>
          </td>
          <td style="text-align:right;"><input type="number" class="inp prqty" value="${Number(row.qty)||1}" min="1" style="width:90px;text-align:right;" /></td>
          <td style="text-align:right;">
            <div class="actions">
              <button class="btn small prMinus">-1</button>
              <button class="btn small prPlus">+1</button>
              <button class="btn small danger prDel">Remove</button>
            </div>
          </td>
        </tr>
      `).join('');

      // Attach handlers
      prCartTbody.querySelectorAll('tr').forEach(tr => {
        const sku = tr.getAttribute('data-sku');
        const qtyInp = tr.querySelector('.prqty');
        const btnMinus = tr.querySelector('.prMinus');
        const btnPlus = tr.querySelector('.prPlus');
        const btnDel = tr.querySelector('.prDel');
        qtyInp.addEventListener('change', () => { const v = Math.max(1, parseInt(qtyInp.value, 10)||1); const row = state.prCart.find(r => String(r.sku) === sku); if (row) row.qty = v; savePrCart(); renderPrCart(); });
        btnMinus.addEventListener('click', () => { const row = state.prCart.find(r => String(r.sku) === sku); if (row) { row.qty = Math.max(1, (row.qty||1) - 1); savePrCart(); renderPrCart(); } });
        btnPlus.addEventListener('click', () => { const row = state.prCart.find(r => String(r.sku) === sku); if (row) { row.qty = (row.qty||1) + 1; savePrCart(); renderPrCart(); } });
        btnDel.addEventListener('click', () => { state.prCart = state.prCart.filter(r => String(r.sku) !== sku); savePrCart(); renderPrCart(); });
      });
    }

    // ---------------- Events ----------------
    tabBtnScan.addEventListener('click', () => { state.tab = 'scan'; render(); focusScanInputSoon(); });
    tabBtnInv.addEventListener('click', () => { state.tab = 'inventory'; render(); });
    tabBtnMov.addEventListener('click', () => { if (state.role === 'pr') return; state.tab = 'movements'; render(); });
    tabBtnRem.addEventListener('click', () => { if (state.role === 'pr') return; state.tab = 'removals'; render(); });
    tabBtnReq.addEventListener('click', () => { if (state.role === 'pr') return; state.tab = 'requests'; render(); });

    soundChk.addEventListener('change', () => { setPrefs({ sound: !!soundChk.checked }); if (soundChk.checked) ensureAudioCtx(); });
    exportBtn.addEventListener('click', () => { if (state.role === 'pr') return; download('inventory.csv', toCSV(state.items), 'text/csv'); });
    importBtn.addEventListener('click', () => { if (state.role === 'pr') return; importFile.click(); });
    importFile.addEventListener('change', (e) => { const f = e.target.files && e.target.files[0]; if (f) importCSVFile(f); e.target.value = ''; });
    demoBtn.addEventListener('click', () => { if (state.role === 'pr') return; loadDemo(); });
    clearBtn.addEventListener('click', () => { if (state.role === 'pr') return; clearAll(); });

    searchInput.addEventListener('input', () => { state.search = searchInput.value; render(); });
    searchInput2.addEventListener('input', () => { state.search = searchInput2.value; render(); });

    modeSwitch.querySelectorAll('.seg').forEach(seg => seg.addEventListener('click', () => { if (state.role === 'pr') return; state.mode = seg.dataset.mode; render(); focusScanInputSoon(); }));
    autoResetQtyChk.addEventListener('change', () => setPrefs({ autoResetQty: !!autoResetQtyChk.checked }));
    allowNegativeChk.addEventListener('change', () => { if (state.role === 'pr') { allowNegativeChk.checked = false; return; } setPrefs({ allowNegative: !!allowNegativeChk.checked }); });

    scanCodeInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); processScan(state.scanCode, state.scanQty); } });
    scanCodeInput.addEventListener('input', () => { state.scanCode = scanCodeInput.value; });
    scanQtyInput.addEventListener('input', () => { let v = parseInt(scanQtyInput.value, 10)||1; if (v < 1) v = 1; state.scanQty = v; scanQtyInput.value = v; });
    applyScanBtn.addEventListener('click', () => processScan(state.scanCode, state.scanQty));

    addRowBtn.addEventListener('click', () => { if (state.role === 'pr') return; setItems(prev => [{ id: uid('sku'), sku: 'NEW-SKU', name: 'New Item', stock: 0, price: '', image: '' }, ...prev]); });

    // Create dialog events
    createCancelBtn.addEventListener('click', () => { state.pendingApply = false; closeCreateDialog(); showToast('Scan canceled'); focusScanInputSoon(); });
    createSaveApplyBtn.addEventListener('click', () => { handleCreateSave(true); focusScanInputSoon(); });

    if (newItemImageInput) {
      newItemImageInput.addEventListener('change', async (e) => {
        const f = e.target.files && e.target.files[0];
        if (!f) { state.newItemImageData = ''; if (newItemImagePreview) { newItemImagePreview.src=''; newItemImagePreview.style.display='none'; } return; }
        try { const dataUrl = await fileToDataURL(f, 256, 256); state.newItemImageData = dataUrl; if (newItemImagePreview) { newItemImagePreview.src = dataUrl; newItemImagePreview.style.display = 'block'; } }
        catch { showToast('Could not load image'); }
      });
    }

    // PR cart events
    prSubmitBtn.addEventListener('click', submitPR);
    prClearBtn.addEventListener('click', clearPRCart);

    // ---------------- Auth Gate ----------------
    function roleFromPwd(val) {
      const s = String(val || '').trim();
      if (!s) return null;
      if (s.toLowerCase() === 'best2510store') return 'admin';
      if (s === '2510') return 'pr';
      return null;
    }
    function showAuth() { if (!authOverlay) return; authOverlay.style.display = 'flex'; if (authError) authError.style.display = 'none'; if (authPwd) { authPwd.value = ''; setTimeout(() => { authPwd.focus(); authPwd.select && authPwd.select(); }, 0); } }
    function hideAuth() { if (!authOverlay) return; authOverlay.style.display = 'none'; if (authError) authError.style.display = 'none'; focusScanInputSoon(); }
    function tryUnlock() { const r = roleFromPwd(authPwd && authPwd.value); if (r) { state.role = r; hideAuth(); render(); focusScanInputSoon(); } else { if (authError) authError.style.display = 'block'; if (authPwd) authPwd.select && authPwd.select(); } }
    if (authUnlockBtn) authUnlockBtn.addEventListener('click', tryUnlock);
    if (authPwd) authPwd.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); tryUnlock(); } });

    // Initial render
    // Switch user button and Esc to lock
    if (switchUserBtn) switchUserBtn.addEventListener('click', () => { state.role = null; showAuth(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { state.role = null; showAuth(); } });
    render();
    focusScanInputSoon();
    showAuth();
  </script>
</body>
</html>
